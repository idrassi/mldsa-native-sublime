/* Copyright (c) The mldsa-native project authors
 * SPDX-License-Identifier: Apache-2.0 OR ISC OR MIT
 */

#include "../../../common.h"
#if defined(MLD_ARITH_BACKEND_AARCH64)
/* simpasm: header-end */

.macro montgomery_reduce_long res, inl, inh
    uzp1   \res\().4s, \inl\().4s, \inh\().4s
    mul    \res\().4s, \res\().4s, modulus_twisted.4s
    smlsl  \inl\().2d, \res\().2s, modulus.2s
    smlsl2 \inh\().2d, \res\().4s, modulus.4s
    uzp2   \res\().4s, \inl\().4s, \inh\().4s
.endm

.macro load_polys_inc p0, p1, p2, p3, ptr
    ldr \p1, [\ptr, #1*16]
    ldr \p2, [\ptr, #2*16]
    ldr \p3, [\ptr, #3*16]
    ldr \p0, [\ptr], #4*16
.endm

.macro load_polys p0, p1, p2, p3, ptr, idx
    ldr \p0, [\ptr, #(1024*\idx-4*16)]
    ldr \p1, [\ptr, #(1024*\idx-3*16)]
    ldr \p2, [\ptr, #(1024*\idx-2*16)]
    ldr \p3, [\ptr, #(1024*\idx-1*16)]
.endm

.macro pmull dl, dh, a, b
    smull  \dl\().2d, \a\().2s, \b\().2s
    smull2 \dh\().2d, \a\().4s, \b\().4s
.endm

.macro pmlal dl, dh, a, b
    smlal  \dl\().2d, \a\().2s, \b\().2s
    smlal2 \dh\().2d, \a\().4s, \b\().4s
.endm

    out_ptr .req x0
    a_ptr   .req x1
    b_ptr   .req x2
    count   .req x3
    wtmp    .req w3

    modulus         .req v0
    modulus_twisted .req v1

    a_0      .req v16
    a_1      .req v17
    a_2      .req v18
    a_3      .req v19

    b_0      .req v20
    b_1      .req v21
    b_2      .req v22
    b_3      .req v23

    c_0_lo   .req v24
    c_0_hi   .req v25
    c_1_lo   .req v26
    c_1_hi   .req v27
    c_2_lo   .req v28
    c_2_hi   .req v29
    c_3_lo   .req v30
    c_3_hi   .req v31

    c_0      .req v16
    c_1      .req v17
    c_2      .req v18
    c_3      .req v19

    q_a_0    .req q16
    q_a_1    .req q17
    q_a_2    .req q18
    q_a_3    .req q19

    q_b_0    .req q20
    q_b_1    .req q21
    q_b_2    .req q22
    q_b_3    .req q23

    q_c_0    .req q16
    q_c_1    .req q17
    q_c_2    .req q18
    q_c_3    .req q19

.text
.global MLD_ASM_NAMESPACE(polyvecl_pointwise_acc_montgomery_l4_asm)
.balign 4
MLD_ASM_FN_SYMBOL(polyvecl_pointwise_acc_montgomery_l4_asm)
    // Load MLDSA_Q = 8380417
    movz wtmp, #0xe001
    movk wtmp, #0x7f, lsl #16
    dup modulus.4s, wtmp

    /* check-magic: 58728449 == unsigned_mod(pow(MLDSA_Q, -1, 2**32), 2**32) */
    // Load MLDSA_Q^-1 = 58728449
    movz wtmp, #0x2001
    movk wtmp, #0x380, lsl #16
    dup modulus_twisted.4s, wtmp

    mov count, #(MLDSA_N / 4)

                                             // Instructions:    79
                                             // Expected cycles: 42
                                             // Expected IPC:    1.88
                                             //
                                             // Cycle bound:     42.0
                                             // IPC bound:       1.88
                                             //
                                             // Wall time:     1.26s
                                             // User time:     1.26s
                                             //
                                             // ----------- cycle (expected) ------------>
                                             // 0                        25
                                             // |------------------------|----------------
        ldr q24, [x1, #48]                   // *.........................................
        ldr q7, [x2, #48]                    // *.........................................
        ldr q22, [x2, #1024]                 // .*........................................
        ldr q21, [x2, #2048]                 // .*........................................
        ldr q30, [x1, #1072]                 // ..*.......................................
        ldr q26, [x2, #1072]                 // ..*.......................................
        ldr q16, [x2], #4*16                 // ...*......................................
        ldr q23, [x1, #2064]                 // ...*......................................
        smull v6.2D, v24.2S, v7.2S           // ....*.....................................
        ldr q20, [x1], #4*16                 // ....*.....................................
        smull2 v3.2D, v24.4S, v7.4S          // .....*....................................
        ldr q31, [x1, #960]                  // .....*....................................
        smlal v6.2D, v30.2S, v26.2S          // ......*...................................
        ldr q19, [x2, #3024]                 // ......*...................................
        smlal2 v3.2D, v30.4S, v26.4S         // .......*..................................
        ldr q4, [x2, #3008]                  // .......*..................................
        smull v30.2D, v20.2S, v16.2S         // ........*.................................
        ldr q25, [x1, #1984]                 // ........*.................................
        smlal v30.2D, v31.2S, v22.2S         // .........*................................
        ldr q2, [x2, #-32]                   // .........*................................
        smull2 v18.2D, v20.4S, v16.4S        // ..........*...............................
        ldr q16, [x1, #3008]                 // ..........*...............................
        ldr q28, [x2, #2032]                 // ...........*..............................
        smlal2 v18.2D, v31.4S, v22.4S        // ...........*..............................
        smlal v30.2D, v25.2S, v21.2S         // ............*.............................
        ldr q26, [x1, #-32]                  // ............*.............................
        smlal2 v18.2D, v25.4S, v21.4S        // .............*............................
        ldr q21, [x1, #2032]                 // .............*............................
        ldr q17, [x1, #3056]                 // ..............*...........................
        smlal2 v18.2D, v16.4S, v4.4S         // ..............*...........................
        ldr q7, [x2, #3056]                  // ...............*..........................
        smlal v30.2D, v16.2S, v4.2S          // ...............*..........................
        ldr q31, [x1, #976]                  // ................*.........................
        smull2 v5.2D, v26.4S, v2.4S          // ................*.........................
        smlal v6.2D, v21.2S, v28.2S          // .................*........................
        ldr q24, [x1, #992]                  // .................*........................
        smlal2 v3.2D, v21.4S, v28.4S         // ..................*.......................
        ldr q29, [x2, #992]                  // ..................*.......................
        smlal v6.2D, v17.2S, v7.2S           // ...................*......................
        ldr q28, [x2, #2016]                 // ...................*......................
        smlal2 v3.2D, v17.4S, v7.4S          // ....................*.....................
        ldr q21, [x1, #2016]                 // ....................*.....................
        ldr q22, [x1, #-48]                  // .....................*....................
        smull v4.2D, v26.2S, v2.2S           // .....................*....................
        ldr q27, [x2, #976]                  // ......................*...................
        smlal2 v5.2D, v24.4S, v29.4S         // ......................*...................
        smlal v4.2D, v24.2S, v29.2S          // .......................*..................
        uzp1 v24.4S, v30.4S, v18.4S          // .......................*..................
        ldr q16, [x2, #-48]                  // ........................*.................
        smlal v4.2D, v21.2S, v28.2S          // ........................*.................
        uzp1 v17.4S, v6.4S, v3.4S            // .........................*................
        mul v26.4S, v24.4S, v1.4S            // .........................*................
        ldr q20, [x2, #3040]                 // ..........................*...............
        mul v25.4S, v17.4S, v1.4S            // ...........................*..............
        ldr q24, [x2, #2000]                 // ............................*.............
        ldr q7, [x2, #48]                    // .............................*............
        smull v29.2D, v22.2S, v16.2S         // .............................*............
        smlsl v30.2D, v26.2S, v0.2S          // ..............................*...........
        smlsl2 v18.2D, v26.4S, v0.4S         // ...............................*..........
        ldr q26, [x1, #3040]                 // ...............................*..........
        smlal2 v5.2D, v21.4S, v28.4S         // ................................*.........
        ldr q28, [x2], #4*16                 // .................................*........
        smlsl2 v3.2D, v25.4S, v0.4S          // .................................*........
        smlsl v6.2D, v25.2S, v0.2S           // ..................................*.......
        ldr q25, [x1, #3024]                 // ..................................*.......
        uzp2 v2.4S, v30.4S, v18.4S           // ...................................*......
        smlal2 v5.2D, v26.4S, v20.4S         // ...................................*......
        smlal v29.2D, v31.2S, v27.2S         // ....................................*.....
        ldr q21, [x1, #32]                   // ....................................*.....
        smlal v4.2D, v26.2S, v20.2S          // .....................................*....
        ldr q30, [x1], #4*16                 // .....................................*....
        smlal v29.2D, v23.2S, v24.2S         // ......................................*...
        uzp2 v17.4S, v6.4S, v3.4S            // ......................................*...
        smull2 v18.2D, v22.4S, v16.4S        // .......................................*..
        str q2, [x0], #4*16                  // .......................................*..
        ldr q3, [x1, #1984]                  // ........................................*.
        smlal v29.2D, v25.2S, v19.2S         // ........................................*.
        smull2 v26.2D, v30.4S, v28.4S        // .........................................*
        uzp1 v22.4S, v4.4S, v5.4S            // .........................................*

                                              // ----------- cycle (expected) ------------>
                                              // 0                        25
                                              // |------------------------|----------------
        // ldr q21, [x1, #32]                 // ............*.............................
        // ldr q28, [x2], #4*16               // ...*......................................
        // ldr q30, [x1], #4*16               // ....*.....................................
        // ldr q7, [x2, #-16]                 // *.........................................
        // ldr q3, [x1, #1984]                // ........*.................................
        // smull2 v26.2D, v30.4S, v28.4S      // ..........*...............................
        // ldr q22, [x2, #960]                // .*........................................
        // ldr q20, [x1, #960]                // .....*....................................
        // ldr q2, [x2, #3008]                // .......*..................................
        // ldr q27, [x2, #1984]               // .*........................................
        // ldr q23, [x1, #3008]               // ..........*...............................
        // smull v17.2D, v30.2S, v28.2S       // ........*.................................
        // ldr q24, [x2, #3040]               // ..........................*...............
        // smlal2 v26.2D, v20.4S, v22.4S      // ...........*..............................
        // smlal2 v26.2D, v3.4S, v27.4S       // .............*............................
        // ldr q30, [x2, #-32]                // .........*................................
        // smlal2 v26.2D, v23.4S, v2.4S       // ..............*...........................
        // ldr q31, [x2, #992]                // ..................*.......................
        // ldr q6, [x1, #-16]                 // *.........................................
        // smlal v17.2D, v20.2S, v22.2S       // .........*................................
        // ldr q20, [x1, #992]                // .................*........................
        // smlal v17.2D, v3.2S, v27.2S        // ............*.............................
        // ldr q27, [x2, #1008]               // ..*.......................................
        // smlal v17.2D, v23.2S, v2.2S        // ...............*..........................
        // ldr q23, [x1, #1008]               // ..*.......................................
        // smull2 v5.2D, v21.4S, v30.4S       // ................*.........................
        // smlal2 v5.2D, v20.4S, v31.4S       // ......................*...................
        // ldr q28, [x2, #2032]               // ...........*..............................
        // ldr q25, [x1, #2032]               // .............*............................
        // smull v2.2D, v6.2S, v7.2S          // ....*.....................................
        // uzp1 v19.4S, v17.4S, v26.4S        // .......................*..................
        // smlal v2.2D, v23.2S, v27.2S        // ......*...................................
        // mul v16.4S, v19.4S, v1.4S          // .........................*................
        // ldr q4, [x1, #3056]                // ..............*...........................
        // ldr q19, [x2, #3056]               // ...............*..........................
        // smlal v2.2D, v25.2S, v28.2S        // .................*........................
        // ldr q3, [x1, #2016]                // ....................*.....................
        // smlsl v17.2D, v16.2S, v0.2S        // ..............................*...........
        // smlsl2 v26.2D, v16.4S, v0.4S       // ...............................*..........
        // smlal v2.2D, v4.2S, v19.2S         // ...................*......................
        // ldr q16, [x2, #2016]               // ...................*......................
        // uzp2 v17.4S, v17.4S, v26.4S        // ...................................*......
        // smull2 v26.2D, v6.4S, v7.4S        // .....*....................................
        // smlal2 v26.2D, v23.4S, v27.4S      // .......*..................................
        // ldr q27, [x1, #3040]               // ...............................*..........
        // smlal2 v26.2D, v25.4S, v28.4S      // ..................*.......................
        // str q17, [x0], #4*16               // .......................................*..
        // smlal2 v26.2D, v4.4S, v19.4S       // ....................*.....................
        // smull v4.2D, v21.2S, v30.2S        // .....................*....................
        // ldr q21, [x1, #32]                 // ....................................*.....
        // smlal v4.2D, v20.2S, v31.2S        // .......................*..................
        // smlal v4.2D, v3.2S, v16.2S         // ........................*.................
        // ldr q18, [x1, #-48]                // .....................*....................
        // smlal v4.2D, v27.2S, v24.2S        // .....................................*....
        // uzp1 v31.4S, v2.4S, v26.4S         // .........................*................
        // smlal2 v5.2D, v3.4S, v16.4S        // ................................*.........
        // ldr q7, [x2, #-48]                 // ........................*.................
        // mul v22.4S, v31.4S, v1.4S          // ...........................*..............
        // ldr q31, [x1, #976]                // ................*.........................
        // ldr q28, [x2], #4*16               // .................................*........
        // ldr q19, [x2, #2960]               // ......*...................................
        // smlal2 v5.2D, v27.4S, v24.4S       // ...................................*......
        // ldr q27, [x2, #912]                // ......................*...................
        // smull v29.2D, v18.2S, v7.2S        // .............................*............
        // ldr q24, [x2, #1936]               // ............................*.............
        // smull2 v18.2D, v18.4S, v7.4S       // .......................................*..
        // ldr q23, [x1, #2000]               // ...*......................................
        // smlsl2 v26.2D, v22.4S, v0.4S       // .................................*........
        // ldr q25, [x1, #3024]               // ..................................*.......
        // smlsl v2.2D, v22.2S, v0.2S         // ..................................*.......
        // ldr q30, [x1], #4*16               // .....................................*....
        // smlal v29.2D, v31.2S, v27.2S       // ....................................*.....
        // uzp1 v22.4S, v4.4S, v5.4S          // .........................................*
        // smlal v29.2D, v23.2S, v24.2S       // ......................................*...
        // ldr q7, [x2, #-16]                 // .............................*............
        // smlal v29.2D, v25.2S, v19.2S       // ........................................*.
        // ldr q3, [x1, #1984]                // ........................................*.
        // uzp2 v17.4S, v2.4S, v26.4S         // ......................................*...
        // smull2 v26.2D, v30.4S, v28.4S      // .........................................*

        sub count, count, #8
l4_loop_start:
                                             // Instructions:    88
                                             // Expected cycles: 48
                                             // Expected IPC:    1.83
                                             //
                                             // Cycle bound:     48.0
                                             // IPC bound:       1.83
                                             //
                                             // Wall time:     7.22s
                                             // User time:     7.22s
                                             //
                                             // -------------- cycle (expected) --------------->
                                             // 0                        25
                                             // |------------------------|----------------------
        mul v16.4S, v22.4S, v1.4S            // l...............................................
        ldr q22, [x2, #960]                  // *...............................................
        ldr q20, [x1, #960]                  // .*..............................................
        ldr q2, [x2, #3008]                  // .*..............................................
        smlal2 v18.2D, v31.4S, v27.4S        // ..l.............................................
        ldr q27, [x2, #1984]                 // ..*.............................................
        smlal2 v18.2D, v23.4S, v24.4S        // ...l............................................
        ldr q23, [x1, #3008]                 // ...*............................................
        str q17, [x0, #-16]                  // ....l...........................................
        smull v17.2D, v30.2S, v28.2S         // ....*...........................................
        ldr q24, [x2, #3040]                 // .....*..........................................
        smlal2 v26.2D, v20.4S, v22.4S        // .....*..........................................
        smlal2 v26.2D, v3.4S, v27.4S         // ......*.........................................
        ldr q30, [x2, #-32]                  // ......*.........................................
        smlal2 v26.2D, v23.4S, v2.4S         // .......*........................................
        ldr q31, [x2, #992]                  // .......*........................................
        smlsl v4.2D, v16.2S, v0.2S           // ........l.......................................
        ldr q6, [x1, #-16]                   // .........*......................................
        smlsl2 v5.2D, v16.4S, v0.4S          // .........l......................................
        smlal v17.2D, v20.2S, v22.2S         // ..........*.....................................
        ldr q20, [x1, #992]                  // ..........*.....................................
        smlal v17.2D, v3.2S, v27.2S          // ...........*....................................
        ldr q27, [x2, #1008]                 // ...........*....................................
        smlal v17.2D, v23.2S, v2.2S          // ............*...................................
        ldr q23, [x1, #1008]                 // ............*...................................
        uzp2 v4.4S, v4.4S, v5.4S             // .............l..................................
        smull2 v5.2D, v21.4S, v30.4S         // .............*..................................
        smlal2 v5.2D, v20.4S, v31.4S         // ..............*.................................
        ldr q28, [x2, #2032]                 // ..............*.................................
        smlal2 v18.2D, v25.4S, v19.4S        // ...............l................................
        ldr q25, [x1, #2032]                 // ...............*................................
        smull v2.2D, v6.2S, v7.2S            // ................*...............................
        uzp1 v19.4S, v17.4S, v26.4S          // ................*...............................
        smlal v2.2D, v23.2S, v27.2S          // .................*..............................
        str q4, [x0, #-32]                   // .................l..............................
        mul v16.4S, v19.4S, v1.4S            // ..................*.............................
        ldr q4, [x1, #3056]                  // ..................*.............................
        uzp1 v22.4S, v29.4S, v18.4S          // ...................l............................
        ldr q19, [x2, #3056]                 // ...................*............................
        smlal v2.2D, v25.2S, v28.2S          // ....................*...........................
        ldr q3, [x1, #2016]                  // ....................*...........................
        mul v22.4S, v22.4S, v1.4S            // .....................l..........................
        smlsl v17.2D, v16.2S, v0.2S          // .......................*........................
        smlsl2 v26.2D, v16.4S, v0.4S         // ........................*.......................
        smlal v2.2D, v4.2S, v19.2S           // .........................*......................
        smlsl2 v18.2D, v22.4S, v0.4S         // ..........................l.....................
        smlsl v29.2D, v22.2S, v0.2S          // ...........................l....................
        ldr q16, [x2, #2016]                 // ...........................*....................
        uzp2 v17.4S, v17.4S, v26.4S          // ............................*...................
        smull2 v26.2D, v6.4S, v7.4S          // ............................*...................
        smlal2 v26.2D, v23.4S, v27.4S        // .............................*..................
        ldr q27, [x1, #3040]                 // .............................*..................
        smlal2 v26.2D, v25.4S, v28.4S        // ..............................*.................
        str q17, [x0], #4*16                 // ..............................*.................
        smlal2 v26.2D, v4.4S, v19.4S         // ...............................*................
        uzp2 v7.4S, v29.4S, v18.4S           // ...............................l................
        smull v4.2D, v21.2S, v30.2S          // ................................*...............
        ldr q21, [x1, #32]                   // ................................e...............
        smlal v4.2D, v20.2S, v31.2S          // .................................*..............
        str q7, [x0, #-112]                  // .................................l..............
        smlal v4.2D, v3.2S, v16.2S           // ..................................*.............
        ldr q18, [x1, #-48]                  // ..................................*.............
        smlal v4.2D, v27.2S, v24.2S          // ...................................*............
        uzp1 v31.4S, v2.4S, v26.4S           // ...................................*............
        smlal2 v5.2D, v3.4S, v16.4S          // ....................................*...........
        ldr q7, [x2, #-48]                   // ....................................*...........
        mul v22.4S, v31.4S, v1.4S            // .....................................*..........
        ldr q31, [x1, #976]                  // .....................................*..........
        ldr q28, [x2], #4*16                 // ......................................e.........
        ldr q19, [x2, #2960]                 // ......................................*.........
        smlal2 v5.2D, v27.4S, v24.4S         // .......................................*........
        ldr q27, [x2, #912]                  // .......................................*........
        smull v29.2D, v18.2S, v7.2S          // ........................................*.......
        ldr q24, [x2, #1936]                 // ........................................*.......
        smull2 v18.2D, v18.4S, v7.4S         // .........................................*......
        ldr q23, [x1, #2000]                 // .........................................*......
        smlsl2 v26.2D, v22.4S, v0.4S         // ..........................................*.....
        ldr q25, [x1, #3024]                 // ..........................................*.....
        smlsl v2.2D, v22.2S, v0.2S           // ...........................................*....
        ldr q30, [x1], #4*16                 // ...........................................e....
        smlal v29.2D, v31.2S, v27.2S         // ............................................*...
        uzp1 v22.4S, v4.4S, v5.4S            // ............................................*...
        smlal v29.2D, v23.2S, v24.2S         // .............................................*..
        ldr q7, [x2, #-16]                   // .............................................e..
        smlal v29.2D, v25.2S, v19.2S         // ..............................................*.
        ldr q3, [x1, #1984]                  // ..............................................e.
        uzp2 v17.4S, v2.4S, v26.4S           // ...............................................*
        smull2 v26.2D, v30.4S, v28.4S        // ...............................................e

                                              // --------------------------------------- cycle (expected) ---------------------------------------->
                                              // 0                        25                       50                       75
                                              // |------------------------|------------------------|------------------------|----------------------
        // ldr q17, [x1, #1*16]               // ..~.............'.................................*.............'.................................
        // ldr q18, [x1, #2*16]               // e...............'...............................~...............'...............................~.
        // ldr q19, [x1, #3*16]               // ................'........*......................................'........~........................
        // ldr q16, [x1], #4*16               // ...........e....'..........................................~....'.................................
        // ldr q21, [x2, #1*16]               // ....~...........'...................................*...........'.................................
        // ldr q22, [x2, #2*16]               // ................'.....*.........................................'.....~...........................
        // ldr q23, [x2, #3*16]               // .............e..'............................................~..'.................................
        // ldr q20, [x2], #4*16               // ......e.........'.....................................~.........'.................................
        // smull  v24.2d, v16.2s, v20.2s      // ................'...*...........................................'...~.............................
        // smull2 v25.2d, v16.4s, v20.4s      // ...............e'..............................................~'.................................
        // smull  v26.2d, v17.2s, v21.2s      // ........~.......'.......................................*.......'.................................
        // smull2 v27.2d, v17.4s, v21.4s      // .........~......'........................................*......'.................................
        // smull  v28.2d, v18.2s, v22.2s      // ~...............'...............................*...............'...............................~.
        // smull2 v29.2d, v18.4s, v22.4s      // ................'............*..................................'............~....................
        // smull  v30.2d, v19.2s, v23.2s      // ................'...............*...............................'...............~.................
        // smull2 v31.2d, v19.4s, v23.4s      // ................'...........................*...................'...........................~.....
        // ldr q16, [x1, #(1024*1-4*16)]      // ................'*..............................................'~................................
        // ldr q17, [x1, #(1024*1-3*16)]      // .....~..........'....................................*..........'.................................
        // ldr q18, [x1, #(1024*1-2*16)]      // ................'.........*.....................................'.........~.......................
        // ldr q19, [x1, #(1024*1-1*16)]      // ................'...........*...................................'...........~.....................
        // ldr q20, [x2, #(1024*1-4*16)]      // ................*...............................................~.................................
        // ldr q21, [x2, #(1024*1-3*16)]      // .......~........'......................................*........'.................................
        // ldr q22, [x2, #(1024*1-2*16)]      // ................'......*........................................'......~..........................
        // ldr q23, [x2, #(1024*1-1*16)]      // ................'..........*....................................'..........~......................
        // smlal  v24.2d, v16.2s, v20.2s      // ................'.........*.....................................'.........~.......................
        // smlal2 v25.2d, v16.4s, v20.4s      // ................'....*..........................................'....~............................
        // smlal  v26.2d, v17.2s, v21.2s      // ............~...'...........................................*...'.................................
        // smlal2 v27.2d, v17.4s, v21.4s      // ................'.~.............................................'.l...............................
        // smlal  v28.2d, v18.2s, v22.2s      // .~..............'................................*..............'.................................
        // smlal2 v29.2d, v18.4s, v22.4s      // ................'.............*.................................'.............~...................
        // smlal  v30.2d, v19.2s, v23.2s      // ................'................*..............................'................~................
        // smlal2 v31.2d, v19.4s, v23.4s      // ................'............................*..................'............................~....
        // ldr q16, [x1, #(1024*2-4*16)]      // ..............e.'.............................................~.'.................................
        // ldr q17, [x1, #(1024*2-3*16)]      // .........~......'........................................*......'.................................
        // ldr q18, [x1, #(1024*2-2*16)]      // ................'...................*...........................'...................~.............
        // ldr q19, [x1, #(1024*2-1*16)]      // ................'..............*................................'..............~..................
        // ldr q20, [x2, #(1024*2-4*16)]      // ................'.*.............................................'.~...............................
        // ldr q21, [x2, #(1024*2-3*16)]      // ........~.......'.......................................*.......'.................................
        // ldr q22, [x2, #(1024*2-2*16)]      // ................'..........................*....................'..........................~......
        // ldr q23, [x2, #(1024*2-1*16)]      // ................'.............*.................................'.............~...................
        // smlal  v24.2d, v16.2s, v20.2s      // ................'..........*....................................'..........~......................
        // smlal2 v25.2d, v16.4s, v20.4s      // ................'.....*.........................................'.....~...........................
        // smlal  v26.2d, v17.2s, v21.2s      // .............~..'............................................*..'.................................
        // smlal2 v27.2d, v17.4s, v21.4s      // ................'..~............................................'..l..............................
        // smlal  v28.2d, v18.2s, v22.2s      // ..~.............'.................................*.............'.................................
        // smlal2 v29.2d, v18.4s, v22.4s      // ....~...........'...................................*...........'.................................
        // smlal  v30.2d, v19.2s, v23.2s      // ................'...................*...........................'...................~.............
        // smlal2 v31.2d, v19.4s, v23.4s      // ................'.............................*.................'.............................~...
        // ldr q16, [x1, #(1024*3-4*16)]      // ................'..*............................................'..~..............................
        // ldr q17, [x1, #(1024*3-3*16)]      // ..........~.....'.........................................*.....'.................................
        // ldr q18, [x1, #(1024*3-2*16)]      // ................'............................*..................'............................~....
        // ldr q19, [x1, #(1024*3-1*16)]      // ................'.................*.............................'.................~...............
        // ldr q20, [x2, #(1024*3-4*16)]      // ................'*..............................................'~................................
        // ldr q21, [x2, #(1024*3-3*16)]      // ......~.........'.....................................*.........'.................................
        // ldr q22, [x2, #(1024*3-2*16)]      // ................'....*..........................................'....~............................
        // ldr q23, [x2, #(1024*3-1*16)]      // ................'..................*............................'..................~..............
        // smlal  v24.2d, v16.2s, v20.2s      // ................'...........*...................................'...........~.....................
        // smlal2 v25.2d, v16.4s, v20.4s      // ................'......*........................................'......~..........................
        // smlal  v26.2d, v17.2s, v21.2s      // ..............~.'.............................................*.'.................................
        // smlal2 v27.2d, v17.4s, v21.4s      // ................'..............~................................'..............l..................
        // smlal  v28.2d, v18.2s, v22.2s      // ...~............'..................................*............'.................................
        // smlal2 v29.2d, v18.4s, v22.4s      // .......~........'......................................*........'.................................
        // smlal  v30.2d, v19.2s, v23.2s      // ................'........................*......................'........................~........
        // smlal2 v31.2d, v19.4s, v23.4s      // ................'..............................*................'..............................~..
        // uzp1   v16.4s, v24.4s, v25.4s      // ................'...............*...............................'...............~.................
        // mul    v16.4s, v16.4s, v1.4s       // ................'.................*.............................'.................~...............
        // smlsl  v24.2d, v16.2s, v0.2s       // ................'......................*........................'......................~..........
        // smlsl2 v25.2d, v16.4s, v0.4s       // ................'.......................*.......................'.......................~.........
        // uzp2   v16.4s, v24.4s, v25.4s      // ................'...........................*...................'...........................~.....
        // uzp1   v17.4s, v26.4s, v27.4s      // ................'..................~............................'..................l..............
        // mul    v17.4s, v17.4s, v1.4s       // ................'....................~..........................'....................l............
        // smlsl  v26.2d, v17.2s, v0.2s       // ................'..........................~....................'..........................l......
        // smlsl2 v27.2d, v17.4s, v0.4s       // ................'.........................~.....................'.........................l.......
        // uzp2   v17.4s, v26.4s, v27.4s      // ................'..............................~................'..............................l..
        // uzp1   v18.4s, v28.4s, v29.4s      // ............~...'...........................................*...'.................................
        // mul    v18.4s, v18.4s, v1.4s       // ................~...............................................l.................................
        // smlsl  v28.2d, v18.2s, v0.2s       // ................'.......~.......................................'.......l.........................
        // smlsl2 v29.2d, v18.4s, v0.4s       // ................'........~......................................'........l........................
        // uzp2   v18.4s, v28.4s, v29.4s      // ................'............~..................................'............l....................
        // uzp1   v19.4s, v30.4s, v31.4s      // ...~............'..................................*............'.................................
        // mul    v19.4s, v19.4s, v1.4s       // .....~..........'....................................*..........'.................................
        // smlsl  v30.2d, v19.2s, v0.2s       // ...........~....'..........................................*....'.................................
        // smlsl2 v31.2d, v19.4s, v0.4s       // ..........~.....'.........................................*.....'.................................
        // uzp2   v19.4s, v30.4s, v31.4s      // ...............~'..............................................*'.................................
        // str q17, [x0, #1*16]               // .~..............'................................~..............'................................l
        // str q18, [x0, #2*16]               // ................'................~..............................'................l................
        // str q19, [x0, #3*16]               // ................'...~...........................................'...l.............................
        // str q16, [x0], #4*16               // ................'.............................*.................'.............................~...

        subs count, count, 4
        cbnz count, l4_loop_start
                                             // Instructions:    97
                                             // Expected cycles: 64
                                             // Expected IPC:    1.52
                                             //
                                             // Cycle bound:     64.0
                                             // IPC bound:       1.52
                                             //
                                             // Wall time:     13.71s
                                             // User time:     13.71s
                                             //
                                             // ---------------------- cycle (expected) ----------------------->
                                             // 0                        25                       50
                                             // |------------------------|------------------------|-------------
        mul v22.4S, v22.4S, v1.4S            // *...............................................................
        ldr q20, [x1, #2000]                 // *...............................................................
        ldr q6, [x1, #3024]                  // .*..............................................................
        ldr q2, [x2, #-48]                   // .*..............................................................
        smlal2 v18.2D, v31.4S, v27.4S        // ..*.............................................................
        ldr q27, [x1, #-48]                  // ...*............................................................
        smlal2 v18.2D, v23.4S, v24.4S        // ...*............................................................
        ldr q16, [x2, #-32]                  // ....*...........................................................
        smlal2 v18.2D, v25.4S, v19.4S        // ....*...........................................................
        smlsl2 v5.2D, v22.4S, v0.4S          // .....*..........................................................
        str q17, [x0, #-16]                  // ......*.........................................................
        smlsl v4.2D, v22.2S, v0.2S           // ......*.........................................................
        ldr q24, [x2, #976]                  // .......*........................................................
        smull v25.2D, v27.2S, v2.2S          // .......*........................................................
        smull2 v22.2D, v21.4S, v16.4S        // ........*.......................................................
        uzp1 v19.4S, v29.4S, v18.4S          // ........*.......................................................
        smull v16.2D, v21.2S, v16.2S         // .........*......................................................
        ldr q21, [x1, #976]                  // .........*......................................................
        uzp2 v5.4S, v4.4S, v5.4S             // ..........*.....................................................
        smull v4.2D, v30.2S, v28.2S          // ..........*.....................................................
        mul v17.4S, v19.4S, v1.4S            // ...........*....................................................
        ldr q31, [x2, #2000]                 // ...........*....................................................
        ldr q19, [x1, #960]                  // ............*...................................................
        str q5, [x0, #-32]                   // .............*..................................................
        smull2 v30.2D, v27.4S, v2.4S         // .............*..................................................
        smlal v25.2D, v21.2S, v24.2S         // ..............*.................................................
        ldr q28, [x1, #-16]                  // ..............*.................................................
        ldr q5, [x2, #960]                   // ...............*................................................
        smlal2 v30.2D, v21.4S, v24.4S        // ...............*................................................
        smlsl v29.2D, v17.2S, v0.2S          // ................*...............................................
        ldr q24, [x1, #2016]                 // ................*...............................................
        smlal v25.2D, v20.2S, v31.2S         // .................*..............................................
        ldr q27, [x2, #3024]                 // .................*..............................................
        smlal2 v30.2D, v20.4S, v31.4S        // ..................*.............................................
        smull2 v31.2D, v28.4S, v7.4S         // ...................*............................................
        smlal2 v26.2D, v19.4S, v5.4S         // ....................*...........................................
        ldr q2, [x2, #1984]                  // ....................*...........................................
        smlal2 v30.2D, v6.4S, v27.4S         // .....................*..........................................
        ldr q20, [x1, #3008]                 // .....................*..........................................
        smlal v25.2D, v6.2S, v27.2S          // ......................*.........................................
        ldr q6, [x2, #3008]                  // ......................*.........................................
        smlal v4.2D, v19.2S, v5.2S           // .......................*........................................
        ldr q23, [x2, #3040]                 // .......................*........................................
        smlal v4.2D, v3.2S, v2.2S            // ........................*.......................................
        ldr q27, [x2, #992]                  // ........................*.......................................
        ldr q19, [x1, #1008]                 // .........................*......................................
        smlal2 v26.2D, v3.4S, v2.4S          // .........................*......................................
        smlal v4.2D, v20.2S, v6.2S           // ..........................*.....................................
        uzp1 v3.4S, v25.4S, v30.4S           // ..........................*.....................................
        smlal2 v26.2D, v20.4S, v6.4S         // ...........................*....................................
        ldr q20, [x1, #992]                  // ...........................*....................................
        mul v5.4S, v3.4S, v1.4S              // ............................*...................................
        ldr q6, [x2, #2016]                  // .............................*..................................
        ldr q2, [x2, #1008]                  // .............................*..................................
        smull v28.2D, v28.2S, v7.2S          // ..............................*.................................
        ldr q7, [x1, #2032]                  // ..............................*.................................
        ldr q21, [x1, #3040]                 // ...............................*................................
        smlal2 v22.2D, v20.4S, v27.4S        // ...............................*................................
        smlal v16.2D, v20.2S, v27.2S         // ................................*...............................
        ldr q3, [x2, #2032]                  // ................................*...............................
        smlal2 v22.2D, v24.4S, v6.4S         // .................................*..............................
        ldr q27, [x2, #3056]                 // .................................*..............................
        ldr q20, [x1, #3056]                 // ..................................*.............................
        smlal v28.2D, v19.2S, v2.2S          // ..................................*.............................
        smlal v16.2D, v24.2S, v6.2S          // ...................................*............................
        smlal v28.2D, v7.2S, v3.2S           // ....................................*...........................
        smlal2 v31.2D, v19.4S, v2.4S         // .....................................*..........................
        smlal v28.2D, v20.2S, v27.2S         // ......................................*.........................
        smlal2 v31.2D, v7.4S, v3.4S          // .......................................*........................
        smlal2 v31.2D, v20.4S, v27.4S        // ........................................*.......................
        smlal2 v22.2D, v21.4S, v23.4S        // .........................................*......................
        smlal v16.2D, v21.2S, v23.2S         // ..........................................*.....................
        uzp1 v21.4S, v4.4S, v26.4S           // ..........................................*.....................
        smlsl v25.2D, v5.2S, v0.2S           // ...........................................*....................
        uzp1 v6.4S, v28.4S, v31.4S           // ............................................*...................
        mul v7.4S, v21.4S, v1.4S             // ............................................*...................
        mul v6.4S, v6.4S, v1.4S              // ..............................................*.................
        uzp1 v3.4S, v16.4S, v22.4S           // ..............................................*.................
        mul v3.4S, v3.4S, v1.4S              // ................................................*...............
        smlsl2 v30.2D, v5.4S, v0.4S          // ..................................................*.............
        smlsl2 v18.2D, v17.4S, v0.4S         // ...................................................*............
        smlsl v28.2D, v6.2S, v0.2S           // ....................................................*...........
        smlsl v4.2D, v7.2S, v0.2S            // .....................................................*..........
        uzp2 v21.4S, v25.4S, v30.4S          // ......................................................*.........
        smlsl v16.2D, v3.2S, v0.2S           // ......................................................*.........
        smlsl2 v22.2D, v3.4S, v0.4S          // .......................................................*........
        str q21, [x0, #16]                   // ........................................................*.......
        smlsl2 v26.2D, v7.4S, v0.4S          // ........................................................*.......
        smlsl2 v31.2D, v6.4S, v0.4S          // .........................................................*......
        uzp2 v6.4S, v29.4S, v18.4S           // ...........................................................*....
        uzp2 v3.4S, v16.4S, v22.4S           // ...........................................................*....
        uzp2 v30.4S, v4.4S, v26.4S           // ............................................................*...
        str q3, [x0, #32]                    // .............................................................*..
        uzp2 v3.4S, v28.4S, v31.4S           // .............................................................*..
        str q6, [x0, #-48]                   // ..............................................................*.
        str q30, [x0], #4*16                 // ...............................................................*
        str q3, [x0, #-16]                   // ...............................................................*

                                              // ---------------------- cycle (expected) ----------------------->
                                              // 0                        25                       50
                                              // |------------------------|------------------------|-------------
        // mul v16.4S, v22.4S, v1.4S          // *...............................................................
        // ldr q22, [x2, #960]                // ...............*................................................
        // ldr q20, [x1, #960]                // ............*...................................................
        // ldr q2, [x2, #3008]                // ......................*.........................................
        // smlal2 v18.2D, v31.4S, v27.4S      // ..*.............................................................
        // ldr q27, [x2, #1984]               // ....................*...........................................
        // smlal2 v18.2D, v23.4S, v24.4S      // ...*............................................................
        // ldr q23, [x1, #3008]               // .....................*..........................................
        // str q17, [x0, #-16]                // ......*.........................................................
        // smull v17.2D, v30.2S, v28.2S       // ..........*.....................................................
        // ldr q24, [x2, #3040]               // .......................*........................................
        // smlal2 v26.2D, v20.4S, v22.4S      // ....................*...........................................
        // smlal2 v26.2D, v3.4S, v27.4S       // .........................*......................................
        // ldr q30, [x2, #-32]                // ....*...........................................................
        // smlal2 v26.2D, v23.4S, v2.4S       // ...........................*....................................
        // ldr q31, [x2, #992]                // ........................*.......................................
        // smlsl v4.2D, v16.2S, v0.2S         // ......*.........................................................
        // ldr q6, [x1, #-16]                 // ..............*.................................................
        // smlsl2 v5.2D, v16.4S, v0.4S        // .....*..........................................................
        // smlal v17.2D, v20.2S, v22.2S       // .......................*........................................
        // ldr q20, [x1, #992]                // ...........................*....................................
        // smlal v17.2D, v3.2S, v27.2S        // ........................*.......................................
        // ldr q27, [x2, #1008]               // .............................*..................................
        // smlal v17.2D, v23.2S, v2.2S        // ..........................*.....................................
        // ldr q23, [x1, #1008]               // .........................*......................................
        // uzp2 v4.4S, v4.4S, v5.4S           // ..........*.....................................................
        // smull2 v5.2D, v21.4S, v30.4S       // ........*.......................................................
        // smlal2 v5.2D, v20.4S, v31.4S       // ...............................*................................
        // ldr q28, [x2, #2032]               // ................................*...............................
        // smlal2 v18.2D, v25.4S, v19.4S      // ....*...........................................................
        // ldr q25, [x1, #2032]               // ..............................*.................................
        // smull v2.2D, v6.2S, v7.2S          // ..............................*.................................
        // uzp1 v19.4S, v17.4S, v26.4S        // ..........................................*.....................
        // smlal v2.2D, v23.2S, v27.2S        // ..................................*.............................
        // str q4, [x0, #-32]                 // .............*..................................................
        // mul v16.4S, v19.4S, v1.4S          // ............................................*...................
        // ldr q4, [x1, #3056]                // ..................................*.............................
        // uzp1 v22.4S, v29.4S, v18.4S        // ........*.......................................................
        // ldr q19, [x2, #3056]               // .................................*..............................
        // smlal v2.2D, v25.2S, v28.2S        // ....................................*...........................
        // ldr q3, [x1, #2016]                // ................*...............................................
        // mul v22.4S, v22.4S, v1.4S          // ...........*....................................................
        // smlsl v17.2D, v16.2S, v0.2S        // .....................................................*..........
        // smlsl2 v26.2D, v16.4S, v0.4S       // ........................................................*.......
        // smlal v2.2D, v4.2S, v19.2S         // ......................................*.........................
        // smlsl2 v18.2D, v22.4S, v0.4S       // ...................................................*............
        // smlsl v29.2D, v22.2S, v0.2S        // ................*...............................................
        // ldr q16, [x2, #2016]               // .............................*..................................
        // uzp2 v17.4S, v17.4S, v26.4S        // ............................................................*...
        // smull2 v26.2D, v6.4S, v7.4S        // ...................*............................................
        // smlal2 v26.2D, v23.4S, v27.4S      // .....................................*..........................
        // ldr q27, [x1, #3040]               // ...............................*................................
        // smlal2 v26.2D, v25.4S, v28.4S      // .......................................*........................
        // str q17, [x0], #4*16               // ...............................................................*
        // smlal2 v26.2D, v4.4S, v19.4S       // ........................................*.......................
        // uzp2 v7.4S, v29.4S, v18.4S         // ...........................................................*....
        // smull v4.2D, v21.2S, v30.2S        // .........*......................................................
        // smlal v4.2D, v20.2S, v31.2S        // ................................*...............................
        // str q7, [x0, #-112]                // ..............................................................*.
        // smlal v4.2D, v3.2S, v16.2S         // ...................................*............................
        // ldr q18, [x1, #-48]                // ...*............................................................
        // smlal v4.2D, v27.2S, v24.2S        // ..........................................*.....................
        // uzp1 v31.4S, v2.4S, v26.4S         // ............................................*...................
        // smlal2 v5.2D, v3.4S, v16.4S        // .................................*..............................
        // ldr q7, [x2, #-48]                 // .*..............................................................
        // mul v22.4S, v31.4S, v1.4S          // ..............................................*.................
        // ldr q31, [x1, #976]                // .........*......................................................
        // ldr q19, [x2, #3024]               // .................*..............................................
        // smlal2 v5.2D, v27.4S, v24.4S       // .........................................*......................
        // ldr q27, [x2, #976]                // .......*........................................................
        // smull v29.2D, v18.2S, v7.2S        // .......*........................................................
        // ldr q24, [x2, #2000]               // ...........*....................................................
        // smull2 v18.2D, v18.4S, v7.4S       // .............*..................................................
        // ldr q23, [x1, #2000]               // *...............................................................
        // smlsl2 v26.2D, v22.4S, v0.4S       // .........................................................*......
        // ldr q25, [x1, #3024]               // .*..............................................................
        // smlsl v2.2D, v22.2S, v0.2S         // ....................................................*...........
        // smlal v29.2D, v31.2S, v27.2S       // ..............*.................................................
        // uzp1 v22.4S, v4.4S, v5.4S          // ..............................................*.................
        // smlal v29.2D, v23.2S, v24.2S       // .................*..............................................
        // smlal v29.2D, v25.2S, v19.2S       // ......................*.........................................
        // uzp2 v17.4S, v2.4S, v26.4S         // .............................................................*..
        // mul v16.4S, v22.4S, v1.4S          // ................................................*...............
        // smlal2 v18.2D, v31.4S, v27.4S      // ...............*................................................
        // smlal2 v18.2D, v23.4S, v24.4S      // ..................*.............................................
        // str q17, [x0, #-16]                // ...............................................................*
        // smlsl v4.2D, v16.2S, v0.2S         // ......................................................*.........
        // smlsl2 v5.2D, v16.4S, v0.4S        // .......................................................*........
        // uzp2 v4.4S, v4.4S, v5.4S           // ...........................................................*....
        // smlal2 v18.2D, v25.4S, v19.4S      // .....................*..........................................
        // str q4, [x0, #-32]                 // .............................................................*..
        // uzp1 v22.4S, v29.4S, v18.4S        // ..........................*.....................................
        // mul v22.4S, v22.4S, v1.4S          // ............................*...................................
        // smlsl2 v18.2D, v22.4S, v0.4S       // ..................................................*.............
        // smlsl v29.2D, v22.2S, v0.2S        // ...........................................*....................
        // uzp2 v7.4S, v29.4S, v18.4S         // ......................................................*.........
        // str q7, [x0, #-48]                 // ........................................................*.......


    ret

    .unreq out_ptr
    .unreq a_ptr
    .unreq b_ptr
    .unreq count
    .unreq wtmp
    .unreq modulus
    .unreq modulus_twisted
    .unreq a_0
    .unreq a_1
    .unreq a_2
    .unreq a_3
    .unreq b_0
    .unreq b_1
    .unreq b_2
    .unreq b_3
    .unreq c_0_lo
    .unreq c_0_hi
    .unreq c_1_lo
    .unreq c_1_hi
    .unreq c_2_lo
    .unreq c_2_hi
    .unreq c_3_lo
    .unreq c_3_hi
    .unreq c_0
    .unreq c_1
    .unreq c_2
    .unreq c_3
    .unreq q_a_0
    .unreq q_a_1
    .unreq q_a_2
    .unreq q_a_3
    .unreq q_b_0
    .unreq q_b_1
    .unreq q_b_2
    .unreq q_b_3
    .unreq q_c_0
    .unreq q_c_1
    .unreq q_c_2
    .unreq q_c_3

/* simpasm: footer-start */
#endif /* MLD_ARITH_BACKEND_AARCH64 */
