/* Copyright (c) The mldsa-native project authors
   * SPDX-License-Identifier: Apache-2.0 OR ISC OR MIT
    */

#include "../../../common.h"
#if defined(MLD_ARITH_BACKEND_AARCH64) && !defined(MLD_CONFIG_MULTILEVEL_NO_SHARED)
/* simpasm: header-end */

.macro montgomery_reduce_long res, inl, inh
    uzp1   \res\().4s, \inl\().4s, \inh\().4s
    mul    \res\().4s, \res\().4s, modulus_twisted.4s
    smlsl  \inl\().2d, \res\().2s, modulus.2s
    smlsl2 \inh\().2d, \res\().4s, modulus.4s
    uzp2   \res\().4s, \inl\().4s, \inh\().4s
.endm

.macro pmull dl, dh, a, b
    smull  \dl\().2d, \a\().2s, \b\().2s
    smull2 \dh\().2d, \a\().4s, \b\().4s
.endm

    out_ptr .req x0
    a_ptr   .req x1
    b_ptr   .req x2

    count   .req x3
    wtmp    .req w3

    modulus         .req v0
    modulus_twisted .req v1

    a_0      .req v16
    a_1      .req v17
    a_2      .req v18
    a_3      .req v19

    b_0      .req v20
    b_1      .req v21
    b_2      .req v22
    b_3      .req v23

    c_0_lo   .req v24
    c_0_hi   .req v25
    c_1_lo   .req v26
    c_1_hi   .req v27
    c_2_lo   .req v28
    c_2_hi   .req v29
    c_3_lo   .req v30
    c_3_hi   .req v31

    c_0      .req v16
    c_1      .req v17
    c_2      .req v18
    c_3      .req v19

    q_a_0    .req q16
    q_a_1    .req q17
    q_a_2    .req q18
    q_a_3    .req q19

    q_b_0    .req q20
    q_b_1    .req q21
    q_b_2    .req q22
    q_b_3    .req q23

    q_c_0    .req q16
    q_c_1    .req q17
    q_c_2    .req q18
    q_c_3    .req q19

.text
.global MLD_ASM_NAMESPACE(poly_pointwise_montgomery_asm)
.balign 4
MLD_ASM_FN_SYMBOL(poly_pointwise_montgomery_asm)
    // Load MLDSA_Q = 8380417
    movz wtmp, #0xe001
    movk wtmp, #0x7f, lsl #16
    dup modulus.4s, wtmp

    /* check-magic: 58728449 == unsigned_mod(pow(MLDSA_Q, -1, 2**32), 2**32) */
    // Load MLDSA_Q^-1 = 58728449
    movz wtmp, #0x2001
    movk wtmp, #0x380, lsl #16
    dup modulus_twisted.4s, wtmp

    mov count, #(MLDSA_N / 4)

                                             // Instructions:    34
                                             // Expected cycles: 24
                                             // Expected IPC:    1.42
                                             //
                                             // Cycle bound:     24.0
                                             // IPC bound:       1.42
                                             //
                                             // Wall time:     0.14s
                                             // User time:     0.14s
                                             //
                                             // ----- cycle (expected) ------>
                                             // 0                        25
                                             // |------------------------|----
        ldr q3, [x2, #48]                    // *.............................
        ldr q28, [x1, #48]                   // *.............................
        ldr q5, [x1], #4*16                  // .*............................
        ldr q23, [x2, #16]                   // .*............................
        ldr q2, [x2], #4*16                  // ..*...........................
        ldr q19, [x1, #-48]                  // ..*...........................
        ldr q31, [x1, #-32]                  // ...*..........................
        ldr q7, [x2, #-32]                   // ...*..........................
        smull v26.2D, v28.2S, v3.2S          // ....*.........................
        ldr q25, [x2, #32]                   // ....*.........................
        smull2 v24.2D, v28.4S, v3.4S         // .....*........................
        ldr q28, [x2], #4*16                 // .....*........................
        smull v29.2D, v5.2S, v2.2S           // ......*.......................
        ldr q6, [x1, #48]                    // ......*.......................
        smull2 v5.2D, v5.4S, v2.4S           // .......*......................
        ldr q22, [x1, #16]                   // .......*......................
        smull v16.2D, v19.2S, v23.2S         // ........*.....................
        smull2 v18.2D, v19.4S, v23.4S        // .........*....................
        uzp1 v27.4S, v26.4S, v24.4S          // .........*....................
        smull2 v17.2D, v31.4S, v7.4S         // ..........*...................
        mul v19.4S, v27.4S, v1.4S            // ...........*..................
        uzp1 v21.4S, v29.4S, v5.4S           // ...........*..................
        smull v4.2D, v31.2S, v7.2S           // .............*................
        uzp1 v20.4S, v16.4S, v18.4S          // .............*................
        mul v23.4S, v21.4S, v1.4S            // ..............*...............
        smlsl v26.2D, v19.2S, v0.2S          // ................*.............
        smlsl2 v24.2D, v19.4S, v0.4S         // .................*............
        uzp1 v19.4S, v4.4S, v17.4S           // .................*............
        mul v31.4S, v20.4S, v1.4S            // ..................*...........
        smlsl v29.2D, v23.2S, v0.2S          // ....................*.........
        uzp2 v2.4S, v26.4S, v24.4S           // .....................*........
        mul v24.4S, v19.4S, v1.4S            // .....................*........
        smlsl v16.2D, v31.2S, v0.2S          // .......................*......
        str q2, [x0, #48]                    // .......................*......

                                              // ------ cycle (expected) ------>
                                              // 0                        25
                                              // |------------------------|-----
        // ldr q6, [x1, #48]                  // *..............................
        // ldr q28, [x2], #4*16               // ..*............................
        // ldr q22, [x1, #16]                 // ..*............................
        // ldr q25, [x2, #-32]                // ...*...........................
        // ldr q2, [x2, #-16]                 // *..............................
        // ldr q20, [x1], #4*16               // .*.............................
        // ldr q23, [x2, #-48]                // .*.............................
        // ldr q24, [x1, #-32]                // ...*...........................
        // smull2 v26.2D, v6.4S, v2.4S        // .....*.........................
        // smull v2.2D, v6.2S, v2.2S          // ....*..........................
        // smull2 v18.2D, v22.4S, v23.4S      // .........*.....................
        // smull v16.2D, v22.2S, v23.2S       // ........*......................
        // smull v29.2D, v20.2S, v28.2S       // ......*........................
        // smull2 v5.2D, v20.4S, v28.4S       // .......*.......................
        // uzp1 v27.4S, v2.4S, v26.4S         // .........*.....................
        // smull v4.2D, v24.2S, v25.2S        // .............*.................
        // mul v23.4S, v27.4S, v1.4S          // ...........*...................
        // uzp1 v30.4S, v16.4S, v18.4S        // .............*.................
        // ldr q6, [x1, #48]                  // ......*........................
        // ldr q28, [x2], #4*16               // .....*.........................
        // mul v31.4S, v30.4S, v1.4S          // ..................*............
        // uzp1 v7.4S, v29.4S, v5.4S          // ...........*...................
        // ldr q22, [x1, #16]                 // .......*.......................
        // smull2 v17.2D, v24.4S, v25.4S      // ..........*....................
        // ldr q25, [x2, #-32]                // ....*..........................
        // smlsl v2.2D, v23.2S, v0.2S         // ................*..............
        // smlsl2 v26.2D, v23.4S, v0.4S       // .................*.............
        // mul v23.4S, v7.4S, v1.4S           // ..............*................
        // uzp1 v20.4S, v4.4S, v17.4S         // .................*.............
        // smlsl v16.2D, v31.2S, v0.2S        // .......................*.......
        // uzp2 v19.4S, v2.4S, v26.4S         // .....................*.........
        // mul v24.4S, v20.4S, v1.4S          // .....................*.........
        // str q19, [x0, #48]                 // .......................*.......
        // smlsl v29.2D, v23.2S, v0.2S        // ....................*..........

        sub count, count, #8
loop_start:
                                             // Instructions:    40
                                             // Expected cycles: 24
                                             // Expected IPC:    1.67
                                             //
                                             // Cycle bound:     24.0
                                             // IPC bound:       1.67
                                             //
                                             // Wall time:     1.52s
                                             // User time:     1.52s
                                             //
                                             // ----- cycle (expected) ------>
                                             // 0                        25
                                             // |------------------------|----
        smlsl2 v5.2D, v23.4S, v0.4S          // l.............................
        ldr q2, [x2, #-16]                   // *.............................
        smlsl2 v18.2D, v31.4S, v0.4S         // .l............................
        ldr q20, [x1], #4*16                 // .*............................
        smlsl v4.2D, v24.2S, v0.2S           // ..l...........................
        ldr q23, [x2, #-48]                  // ..*...........................
        smlsl2 v17.2D, v24.4S, v0.4S         // ...l..........................
        ldr q24, [x1, #-32]                  // ...*..........................
        uzp2 v27.4S, v29.4S, v5.4S           // ....l.........................
        smull2 v26.2D, v6.4S, v2.4S          // ....*.........................
        smull v2.2D, v6.2S, v2.2S            // .....*........................
        uzp2 v19.4S, v16.4S, v18.4S          // .....l........................
        smull2 v18.2D, v22.4S, v23.4S        // ......*.......................
        str q27, [x0], #4*16                 // ......l.......................
        smull v16.2D, v22.2S, v23.2S         // .......*......................
        str q19, [x0, #-48]                  // .......l......................
        smull v29.2D, v20.2S, v28.2S         // ........*.....................
        uzp2 v3.4S, v4.4S, v17.4S            // ........l.....................
        smull2 v5.2D, v20.4S, v28.4S         // .........*....................
        uzp1 v27.4S, v2.4S, v26.4S           // .........*....................
        str q3, [x0, #-32]                   // ..........l...................
        smull v4.2D, v24.2S, v25.2S          // ..........*...................
        mul v23.4S, v27.4S, v1.4S            // ...........*..................
        uzp1 v30.4S, v16.4S, v18.4S          // ...........*..................
        ldr q6, [x1, #48]                    // ............e.................
        ldr q28, [x2], #4*16                 // ............e.................
        mul v31.4S, v30.4S, v1.4S            // .............*................
        uzp1 v7.4S, v29.4S, v5.4S            // .............*................
        ldr q22, [x1, #16]                   // ..............e...............
        smull2 v17.2D, v24.4S, v25.4S        // ...............*..............
        ldr q25, [x2, #-32]                  // ...............e..............
        smlsl v2.2D, v23.2S, v0.2S           // ................*.............
        smlsl2 v26.2D, v23.4S, v0.4S         // .................*............
        mul v23.4S, v7.4S, v1.4S             // ..................*...........
        uzp1 v20.4S, v4.4S, v17.4S           // ...................*..........
        smlsl v16.2D, v31.2S, v0.2S          // ....................*.........
        uzp2 v19.4S, v2.4S, v26.4S           // .....................*........
        mul v24.4S, v20.4S, v1.4S            // .....................*........
        str q19, [x0, #48]                   // .......................*......
        smlsl v29.2D, v23.2S, v0.2S          // .......................*......

                                              // -------------- cycle (expected) -------------->
                                              // 0                        25
                                              // |------------------------|---------------------
        // ldr q17, [x1, #1*16]               // ..e.........'.............~.........'..........
        // ldr q18, [x1, #2*16]               // ............'..*....................'..~.......
        // ldr q19, [x1, #3*16]               // e...........'...........~...........'..........
        // ldr q16, [x1], #4*16               // ............'*......................'~.........
        // ldr q21, [x2, #1*16]               // ............'.*.....................'.~........
        // ldr q22, [x2, #2*16]               // ...e........'..............~........'..........
        // ldr q23, [x2, #3*16]               // ............*.......................~..........
        // ldr q20, [x2], #4*16               // e...........'...........~...........'..........
        // smull  v24.2d, v16.2s, v20.2s      // ............'.......*...............'.......~..
        // smull2 v25.2d, v16.4s, v20.4s      // ............'........*..............'........~.
        // smull  v26.2d, v17.2s, v21.2s      // ............'......*................'......~...
        // smull2 v27.2d, v17.4s, v21.4s      // ............'.....*.................'.....~....
        // smull  v28.2d, v18.2s, v22.2s      // ............'.........*.............'..........
        // smull2 v29.2d, v18.4s, v22.4s      // ...~........'..............*........'..........
        // smull  v30.2d, v19.2s, v23.2s      // ............'....*..................'....~.....
        // smull2 v31.2d, v19.4s, v23.4s      // ............'...*...................'...~......
        // uzp1   v16.4s, v24.4s, v25.4s      // .~..........'............*..........'..........
        // mul    v16.4s, v16.4s, v1.4s       // ......~.....'.................*.....'..........
        // smlsl  v24.2d, v16.2s, v0.2s       // ...........~'......................*'..........
        // smlsl2 v25.2d, v16.4s, v0.4s       // ............~.......................l..........
        // uzp2   v16.4s, v24.4s, v25.4s      // ............'...~...................'...l......
        // uzp1   v17.4s, v26.4s, v27.4s      // ............'..........*............'..........
        // mul    v17.4s, v17.4s, v1.4s       // .~..........'............*..........'..........
        // smlsl  v26.2d, v17.2s, v0.2s       // ........~...'...................*...'..........
        // smlsl2 v27.2d, v17.4s, v0.4s       // ............'~......................'l.........
        // uzp2   v17.4s, v26.4s, v27.4s      // ............'....~..................'....l.....
        // uzp1   v18.4s, v28.4s, v29.4s      // .......~....'..................*....'..........
        // mul    v18.4s, v18.4s, v1.4s       // .........~..'....................*..'..........
        // smlsl  v28.2d, v18.2s, v0.2s       // ............'.~.....................'.l........
        // smlsl2 v29.2d, v18.4s, v0.4s       // ............'..~....................'..l.......
        // uzp2   v18.4s, v28.4s, v29.4s      // ............'.......~...............'.......l..
        // uzp1   v19.4s, v30.4s, v31.4s      // ............'........*..............'........~.
        // mul    v19.4s, v19.4s, v1.4s       // ............'..........*............'..........
        // smlsl  v30.2d, v19.2s, v0.2s       // ....~.......'...............*.......'..........
        // smlsl2 v31.2d, v19.4s, v0.4s       // .....~......'................*......'..........
        // uzp2   v19.4s, v30.4s, v31.4s      // .........~..'....................*..'..........
        // str q17, [x0, #1*16]               // ............'......~................'......l...
        // str q18, [x0, #2*16]               // ............'.........~.............'.........l
        // str q19, [x0, #3*16]               // ...........~'......................*'..........
        // str q16, [x0], #4*16               // ............'.....~.................'.....l....

        subs count, count, 4
        cbnz count, loop_start
                                             // Instructions:    46
                                             // Expected cycles: 34
                                             // Expected IPC:    1.35
                                             //
                                             // Cycle bound:     34.0
                                             // IPC bound:       1.35
                                             //
                                             // Wall time:     0.22s
                                             // User time:     0.22s
                                             //
                                             // ------- cycle (expected) -------->
                                             // 0                        25
                                             // |------------------------|--------
        smlsl2 v18.2D, v31.4S, v0.4S         // *.................................
        ldr q19, [x2, #-16]                  // *.................................
        smlsl v4.2D, v24.2S, v0.2S           // .*................................
        ldr q30, [x1, #32]                   // .*................................
        smlsl2 v17.2D, v24.4S, v0.4S         // ..*...............................
        ldr q20, [x2, #-48]                  // ..*...............................
        smlsl2 v5.2D, v23.4S, v0.4S          // ...*..............................
        ldr q2, [x1], #4*16                  // ...*..............................
        uzp2 v16.4S, v16.4S, v18.4S          // ....*.............................
        smull2 v26.2D, v6.4S, v19.4S         // ....*.............................
        smull v31.2D, v6.2S, v19.2S          // .....*............................
        uzp2 v18.4S, v4.4S, v17.4S           // ......*...........................
        smull v24.2D, v30.2S, v25.2S         // ......*...........................
        smull2 v6.2D, v30.4S, v25.4S         // .......*..........................
        uzp2 v3.4S, v29.4S, v5.4S            // .......*..........................
        str q18, [x0, #32]                   // ........*.........................
        smull2 v19.2D, v22.4S, v20.4S        // ........*.........................
        smull v23.2D, v22.2S, v20.2S         // .........*........................
        uzp1 v27.4S, v31.4S, v26.4S          // .........*........................
        str q16, [x0, #16]                   // ..........*.......................
        smull v7.2D, v2.2S, v28.2S           // ..........*.......................
        smull2 v5.2D, v2.4S, v28.4S          // ...........*......................
        uzp1 v22.4S, v24.4S, v6.4S           // ...........*......................
        str q3, [x0], #4*16                  // ............*.....................
        mul v17.4S, v27.4S, v1.4S            // ............*.....................
        uzp1 v30.4S, v23.4S, v19.4S          // .............*....................
        mul v21.4S, v22.4S, v1.4S            // ..............*...................
        uzp1 v18.4S, v7.4S, v5.4S            // ...............*..................
        mul v22.4S, v30.4S, v1.4S            // ................*.................
        smlsl2 v26.2D, v17.4S, v0.4S         // ..................*...............
        mul v3.4S, v18.4S, v1.4S             // ...................*..............
        smlsl v31.2D, v17.2S, v0.2S          // .....................*............
        smlsl v24.2D, v21.2S, v0.2S          // ......................*...........
        smlsl2 v19.2D, v22.4S, v0.4S         // .......................*..........
        smlsl2 v5.2D, v3.4S, v0.4S           // ........................*.........
        smlsl v7.2D, v3.2S, v0.2S            // .........................*........
        uzp2 v25.4S, v31.4S, v26.4S          // .........................*........
        smlsl v23.2D, v22.2S, v0.2S          // ..........................*.......
        smlsl2 v6.2D, v21.4S, v0.4S          // ...........................*......
        str q25, [x0, #48]                   // ...........................*......
        uzp2 v26.4S, v7.4S, v5.4S            // .............................*....
        uzp2 v19.4S, v23.4S, v19.4S          // ..............................*...
        uzp2 v21.4S, v24.4S, v6.4S           // ...............................*..
        str q26, [x0], #4*16                 // ...............................*..
        str q19, [x0, #-48]                  // ................................*.
        str q21, [x0, #-32]                  // .................................*

                                              // ------- cycle (expected) -------->
                                              // 0                        25
                                              // |------------------------|--------
        // smlsl2 v5.2D, v23.4S, v0.4S        // ...*..............................
        // ldr q2, [x2, #-16]                 // *.................................
        // smlsl2 v18.2D, v31.4S, v0.4S       // *.................................
        // ldr q20, [x1], #4*16               // ...*..............................
        // smlsl v4.2D, v24.2S, v0.2S         // .*................................
        // ldr q23, [x2, #-48]                // ..*...............................
        // smlsl2 v17.2D, v24.4S, v0.4S       // ..*...............................
        // ldr q24, [x1, #-32]                // .*................................
        // uzp2 v27.4S, v29.4S, v5.4S         // .......*..........................
        // smull2 v26.2D, v6.4S, v2.4S        // ....*.............................
        // smull v2.2D, v6.2S, v2.2S          // .....*............................
        // uzp2 v19.4S, v16.4S, v18.4S        // ....*.............................
        // smull2 v18.2D, v22.4S, v23.4S      // ........*.........................
        // str q27, [x0], #4*16               // ............*.....................
        // smull v16.2D, v22.2S, v23.2S       // .........*........................
        // str q19, [x0, #-48]                // ..........*.......................
        // smull v29.2D, v20.2S, v28.2S       // ..........*.......................
        // uzp2 v3.4S, v4.4S, v17.4S          // ......*...........................
        // smull2 v5.2D, v20.4S, v28.4S       // ...........*......................
        // uzp1 v27.4S, v2.4S, v26.4S         // .........*........................
        // str q3, [x0, #-32]                 // ........*.........................
        // smull v4.2D, v24.2S, v25.2S        // ......*...........................
        // mul v23.4S, v27.4S, v1.4S          // ............*.....................
        // uzp1 v30.4S, v16.4S, v18.4S        // .............*....................
        // mul v31.4S, v30.4S, v1.4S          // ................*.................
        // uzp1 v7.4S, v29.4S, v5.4S          // ...............*..................
        // smull2 v17.2D, v24.4S, v25.4S      // .......*..........................
        // smlsl v2.2D, v23.2S, v0.2S         // .....................*............
        // smlsl2 v26.2D, v23.4S, v0.4S       // ..................*...............
        // mul v23.4S, v7.4S, v1.4S           // ...................*..............
        // uzp1 v20.4S, v4.4S, v17.4S         // ...........*......................
        // smlsl v16.2D, v31.2S, v0.2S        // ..........................*.......
        // uzp2 v19.4S, v2.4S, v26.4S         // .........................*........
        // mul v24.4S, v20.4S, v1.4S          // ..............*...................
        // str q19, [x0, #48]                 // ...........................*......
        // smlsl v29.2D, v23.2S, v0.2S        // .........................*........
        // smlsl2 v5.2D, v23.4S, v0.4S        // ........................*.........
        // smlsl2 v18.2D, v31.4S, v0.4S       // .......................*..........
        // smlsl v4.2D, v24.2S, v0.2S         // ......................*...........
        // smlsl2 v17.2D, v24.4S, v0.4S       // ...........................*......
        // uzp2 v27.4S, v29.4S, v5.4S         // .............................*....
        // uzp2 v19.4S, v16.4S, v18.4S        // ..............................*...
        // str q27, [x0], #4*16               // ...............................*..
        // str q19, [x0, #-48]                // ................................*.
        // uzp2 v3.4S, v4.4S, v17.4S          // ...............................*..
        // str q3, [x0, #-32]                 // .................................*


    ret

    .unreq out_ptr
    .unreq a_ptr
    .unreq b_ptr
    .unreq count
    .unreq wtmp
    .unreq modulus
    .unreq modulus_twisted
    .unreq a_0
    .unreq a_1
    .unreq a_2
    .unreq a_3
    .unreq b_0
    .unreq b_1
    .unreq b_2
    .unreq b_3
    .unreq c_0_lo
    .unreq c_0_hi
    .unreq c_1_lo
    .unreq c_1_hi
    .unreq c_2_lo
    .unreq c_2_hi
    .unreq c_3_lo
    .unreq c_3_hi
    .unreq c_0
    .unreq c_1
    .unreq c_2
    .unreq c_3
    .unreq q_a_0
    .unreq q_a_1
    .unreq q_a_2
    .unreq q_a_3
    .unreq q_b_0
    .unreq q_b_1
    .unreq q_b_2
    .unreq q_b_3
    .unreq q_c_0
    .unreq q_c_1
    .unreq q_c_2
    .unreq q_c_3

/* simpasm: footer-start */
#endif /* MLD_ARITH_BACKEND_AARCH64 && !MLD_CONFIG_MULTILEVEL_NO_SHARED */
