/* Copyright (c) The mldsa-native project authors
 * SPDX-License-Identifier: Apache-2.0 OR ISC OR MIT
 */

#include "../../../common.h"
#if defined(MLD_ARITH_BACKEND_AARCH64)
/* simpasm: header-end */

.macro montgomery_reduce_long res, inl, inh
    uzp1   \res\().4s, \inl\().4s, \inh\().4s
    mul    \res\().4s, \res\().4s, modulus_twisted.4s
    smlsl  \inl\().2d, \res\().2s, modulus.2s
    smlsl2 \inh\().2d, \res\().4s, modulus.4s
    uzp2   \res\().4s, \inl\().4s, \inh\().4s
.endm

.macro load_polys_inc p0, p1, p2, p3, ptr
    ldr \p1, [\ptr, #1*16]
    ldr \p2, [\ptr, #2*16]
    ldr \p3, [\ptr, #3*16]
    ldr \p0, [\ptr], #4*16
.endm

.macro load_polys p0, p1, p2, p3, ptr, idx
    ldr \p0, [\ptr, #(1024*\idx-4*16)]
    ldr \p1, [\ptr, #(1024*\idx-3*16)]
    ldr \p2, [\ptr, #(1024*\idx-2*16)]
    ldr \p3, [\ptr, #(1024*\idx-1*16)]
.endm

.macro pmull dl, dh, a, b
    smull  \dl\().2d, \a\().2s, \b\().2s
    smull2 \dh\().2d, \a\().4s, \b\().4s
.endm

.macro pmlal dl, dh, a, b
    smlal  \dl\().2d, \a\().2s, \b\().2s
    smlal2 \dh\().2d, \a\().4s, \b\().4s
.endm

    out_ptr .req x0
    a_ptr   .req x1
    b_ptr   .req x2
    count   .req x3
    wtmp    .req w3

    modulus         .req v0
    modulus_twisted .req v1

    a_0      .req v16
    a_1      .req v17
    a_2      .req v18
    a_3      .req v19

    b_0      .req v20
    b_1      .req v21
    b_2      .req v22
    b_3      .req v23

    c_0_lo   .req v24
    c_0_hi   .req v25
    c_1_lo   .req v26
    c_1_hi   .req v27
    c_2_lo   .req v28
    c_2_hi   .req v29
    c_3_lo   .req v30
    c_3_hi   .req v31

    c_0      .req v16
    c_1      .req v17
    c_2      .req v18
    c_3      .req v19

    q_a_0    .req q16
    q_a_1    .req q17
    q_a_2    .req q18
    q_a_3    .req q19

    q_b_0    .req q20
    q_b_1    .req q21
    q_b_2    .req q22
    q_b_3    .req q23

    q_c_0    .req q16
    q_c_1    .req q17
    q_c_2    .req q18
    q_c_3    .req q19

.text
.global MLD_ASM_NAMESPACE(polyvecl_pointwise_acc_montgomery_l7_asm)
.balign 4
MLD_ASM_FN_SYMBOL(polyvecl_pointwise_acc_montgomery_l7_asm)
    // Load MLDSA_Q = 8380417
    movz wtmp, #0xe001
    movk wtmp, #0x7f, lsl #16
    dup modulus.4s, wtmp

    /* check-magic: 58728449 == unsigned_mod(pow(MLDSA_Q, -1, 2**32), 2**32) */
    // Load MLDSA_Q^-1 = 58728449
    movz wtmp, #0x2001
    movk wtmp, #0x380, lsl #16
    dup modulus_twisted.4s, wtmp

    mov count, #(MLDSA_N / 4)

        ldr q17, [x1], #4*16                 // *...................................................................................
        ldr q4, [x2], #4*16                  // *...................................................................................
        ldr q5, [x1, #-48]                   // .*..................................................................................
        ldr q31, [x2, #-48]                  // .*..................................................................................
        ldr q26, [x2, #-32]                  // ..*.................................................................................
        ldr q20, [x1, #-16]                  // ..*.................................................................................
        ldr q16, [x1, #-32]                  // ...*................................................................................
        smull v24.2D, v17.2S, v4.2S          // ....*...............................................................................
        ldr q18, [x2, #-16]                  // ....*...............................................................................
        smull2 v27.2D, v5.4S, v31.4S         // .....*..............................................................................
        ldr q7, [x1, #976]                   // .....*..............................................................................
        smull2 v25.2D, v17.4S, v4.4S         // ......*.............................................................................
        ldr q23, [x1, #960]                  // ......*.............................................................................
        smull v28.2D, v16.2S, v26.2S         // .......*............................................................................
        ldr q21, [x2, #976]                  // .......*............................................................................
        smull2 v29.2D, v16.4S, v26.4S        // ........*...........................................................................
        ldr q19, [x1, #2016]                 // ........*...........................................................................
        ldr q22, [x2, #960]                  // .........*..........................................................................
        smull v30.2D, v20.2S, v18.2S         // .........*..........................................................................
        smull v26.2D, v5.2S, v31.2S          // ..........*.........................................................................
        ldr q4, [x1, #1008]                  // ..........*.........................................................................
        smlal v26.2D, v7.2S, v21.2S          // ...........*........................................................................
        ldr q16, [x2, #992]                  // ...........*........................................................................
        smull2 v31.2D, v20.4S, v18.4S        // ............*.......................................................................
        ldr q5, [x1, #992]                   // ............*.......................................................................
        smlal2 v25.2D, v23.4S, v22.4S        // .............*......................................................................
        smlal v24.2D, v23.2S, v22.2S         // ..............*.....................................................................
        ldr q18, [x2, #1008]                 // ..............*.....................................................................
        smlal2 v27.2D, v7.4S, v21.4S         // ...............*....................................................................
        ldr q22, [x1, #1984]                 // ...............*....................................................................
        smlal v28.2D, v5.2S, v16.2S          // ................*...................................................................
        ldr q17, [x2, #1984]                 // ................*...................................................................
        smlal2 v29.2D, v5.4S, v16.4S         // .................*..................................................................
        ldr q16, [x2, #2000]                 // .................*..................................................................
        smlal v30.2D, v4.2S, v18.2S          // ..................*.................................................................
        ldr q5, [x1, #2000]                  // ..................*.................................................................
        smlal2 v31.2D, v4.4S, v18.4S         // ...................*................................................................
        ldr q4, [x2, #2016]                  // ...................*................................................................
        smlal v24.2D, v22.2S, v17.2S         // ....................*...............................................................
        ldr q2, [x1, #2032]                  // ....................*...............................................................
        smlal2 v25.2D, v22.4S, v17.4S        // .....................*..............................................................
        ldr q22, [x1, #3024]                 // .....................*..............................................................
        ldr q18, [x2, #2032]                 // ......................*.............................................................
        smlal v26.2D, v5.2S, v16.2S          // ......................*.............................................................
        smlal2 v27.2D, v5.4S, v16.4S         // .......................*............................................................
        smlal2 v31.2D, v2.4S, v18.4S         // ..........................*.........................................................
        ldr q5, [x2, #3024]                  // ..........................*.........................................................
        smlal2 v29.2D, v19.4S, v4.4S         // ...........................*........................................................
        ldr q3, [x1, #3008]                  // ...........................*........................................................
        ldr q23, [x2, #3008]                 // ............................*.......................................................
        smlal v30.2D, v2.2S, v18.2S          // ............................*.......................................................
        smlal v28.2D, v19.2S, v4.2S          // .............................*......................................................
        ldr q16, [x2, #3040]                 // .............................*......................................................
        ldr q17, [x1, #3040]                 // ..............................*.....................................................
        smlal v26.2D, v22.2S, v5.2S          // ..............................*.....................................................
        smlal2 v27.2D, v22.4S, v5.4S         // ...............................*....................................................
        ldr q22, [x2, #3056]                 // ...............................*....................................................
        ldr q21, [x1, #3056]                 // ................................*...................................................
        smlal2 v25.2D, v3.4S, v23.4S         // ................................*...................................................
        smlal v24.2D, v3.2S, v23.2S          // .................................*..................................................
        ldr q20, [x1, #4080]                 // .................................*..................................................
        ldr q23, [x2, #4080]                 // ..................................*.................................................
        smlal2 v29.2D, v17.4S, v16.4S        // ..................................*.................................................
        smlal v28.2D, v17.2S, v16.2S         // ...................................*................................................
        ldr q7, [x2, #4032]                  // ...................................*................................................
        smlal v30.2D, v21.2S, v22.2S         // ....................................*...............................................
        ldr q19, [x1, #4032]                 // ....................................*...............................................
        ldr q6, [x1, #4048]                  // .....................................*..............................................
        sub count, count, #4
l7_loop_start:
                                             // Instructions:    136
                                             // Expected cycles: 72
                                             // Expected IPC:    1.89

                                             // -------------------------- cycle (expected) --------------------------->
                                             // 0                        25                       50
                                             // |------------------------|------------------------|---------------------
        smlal v30.2D, v20.2S, v23.2S         // *.......................................................................
        ldr q3, [x2, #4048]                  // *.......................................................................
        smlal2 v31.2D, v21.4S, v22.4S        // .*......................................................................
        ldr q18, [x2, #5104]                 // .*......................................................................
        ldr q2, [x1, #5104]                  // ..*.....................................................................
        smlal2 v31.2D, v20.4S, v23.4S        // ..*.....................................................................
        ldr q16, [x2, #5072]                 // ...*....................................................................
        smlal v24.2D, v19.2S, v7.2S          // ...*....................................................................
        smlal v26.2D, v6.2S, v3.2S           // ....*...................................................................
        ldr q17, [x2, #5056]                 // ....*...................................................................
        ldr q20, [x1, #5056]                 // .....*..................................................................
        smlal2 v27.2D, v6.4S, v3.4S          // .....*..................................................................
        ldr q5, [x1, #6080]                  // ......*.................................................................
        smlal2 v25.2D, v19.4S, v7.4S         // ......*.................................................................
        smlal v30.2D, v2.2S, v18.2S          // .......*................................................................
        ldr q21, [x2, #6080]                 // .......*................................................................
        ldr q22, [x2, #4064]                 // ........*...............................................................
        smlal2 v31.2D, v2.4S, v18.4S         // ........*...............................................................
        smlal v24.2D, v20.2S, v17.2S         // .........*..............................................................
        ldr q23, [x1, #5072]                 // .........*..............................................................
        ldr q3, [x1, #4064]                  // ..........*.............................................................
        smlal2 v25.2D, v20.4S, v17.4S        // ..........*.............................................................
        smlal v24.2D, v5.2S, v21.2S          // ...........*............................................................
        ldr q2, [x1, #6128]                  // ...........*............................................................
        ldr q17, [x2, #6128]                 // ............*...........................................................
        smlal2 v25.2D, v5.4S, v21.4S         // ............*...........................................................
        smlal v26.2D, v23.2S, v16.2S         // .............*..........................................................
        ldr q5, [x2, #6096]                  // .............*..........................................................
        smlal2 v29.2D, v3.4S, v22.4S         // ..............*.........................................................
        ldr q4, [x2, #5088]                  // ..............*.........................................................
        smlal v28.2D, v3.2S, v22.2S          // ...............*........................................................
        ldr q22, [x2, #6112]                 // ...............*........................................................
        smlal v30.2D, v2.2S, v17.2S          // ................*.......................................................
        uzp1 v21.4S, v24.4S, v25.4S          // ................*.......................................................
        ldr q20, [x1, #6096]                 // .................*......................................................
        smlal2 v27.2D, v23.4S, v16.4S        // .................*......................................................
        mul v18.4S, v21.4S, v1.4S            // ..................*.....................................................
        ldr q23, [x1, #5088]                 // ..................*.....................................................
        ldr q3, [x1, #6112]                  // ...................*....................................................
        ldr q6, [x2], #4*16                  // ...................*....................................................
        smlal2 v31.2D, v2.4S, v17.4S         // ....................*...................................................
        smlal v26.2D, v20.2S, v5.2S          // .....................*..................................................
        ldr q2, [x1, #1024]                  // .....................*..................................................
        ldr q16, [x1], #4*16                 // ......................*.................................................
        smlal2 v29.2D, v23.4S, v4.4S         // ......................*.................................................
        smlsl v24.2D, v18.2S, v0.2S          // .......................*................................................
        ldr q21, [x1, #1984]                 // .......................*................................................
        smlsl2 v25.2D, v18.4S, v0.4S         // ........................*...............................................
        ldr q18, [x2, #960]                  // ........................*...............................................
        smlal v28.2D, v23.2S, v4.2S          // .........................*..............................................
        smlal2 v27.2D, v20.4S, v5.4S         // ..........................*.............................................
        ldr q17, [x1, #3008]                 // ..........................*.............................................
        smlal v28.2D, v3.2S, v22.2S          // ...........................*............................................
        ldr q5, [x2, #3008]                  // ...........................*............................................
        smlal2 v29.2D, v3.4S, v22.4S         // ............................*...........................................
        uzp2 v19.4S, v24.4S, v25.4S          // ............................*...........................................
        ldr q4, [x2, #1984]                  // .............................*..........................................
        smull v24.2D, v16.2S, v6.2S          // .............................*..........................................
        smull2 v25.2D, v16.4S, v6.4S         // ..............................*.........................................
        uzp1 v23.4S, v30.4S, v31.4S          // ..............................*.........................................
        smlal2 v25.2D, v2.4S, v18.4S         // ...............................*........................................
        mul v6.4S, v23.4S, v1.4S             // ................................*.......................................
        smlal v24.2D, v2.2S, v18.2S          // ..................................*.....................................
        smlal v24.2D, v21.2S, v4.2S          // ...................................*....................................
        smlal v24.2D, v17.2S, v5.2S          // ....................................*...................................
        uzp1 v23.4S, v28.4S, v29.4S          // ....................................*...................................
        uzp1 v2.4S, v26.4S, v27.4S           // .....................................*..................................
        smlsl2 v31.2D, v6.4S, v0.4S          // .....................................*..................................
        ldr q20, [x2, #-32]                  // ......................................*.................................
        smlsl v30.2D, v6.2S, v0.2S           // ......................................*.................................
        mul v2.4S, v2.4S, v1.4S              // .......................................*................................
        ldr q18, [x1, #-16]                  // .......................................*................................
        ldr q6, [x2, #2032]                  // ........................................*...............................
        ldr q22, [x2, #1008]                 // ........................................*...............................
        mul v23.4S, v23.4S, v1.4S            // .........................................*..............................
        ldr q3, [x1, #-48]                   // .........................................*..............................
        uzp2 v31.4S, v30.4S, v31.4S          // ..........................................*.............................
        ldr q30, [x2, #-16]                  // ..........................................*.............................
        str q19, [x0], #4*16                 // ...........................................*............................
        smlal2 v25.2D, v21.4S, v4.4S         // ...........................................*............................
        ldr q7, [x1, #2032]                  // ............................................*...........................
        smlsl2 v27.2D, v2.4S, v0.4S          // ............................................*...........................
        smlsl v26.2D, v2.2S, v0.2S           // .............................................*..........................
        ldr q19, [x2, #-48]                  // .............................................*..........................
        smlsl2 v29.2D, v23.4S, v0.4S         // ..............................................*.........................
        ldr q4, [x1, #976]                   // ..............................................*.........................
        str q31, [x0, #-16]                  // ...............................................*........................
        smull2 v31.2D, v18.4S, v30.4S        // ...............................................*........................
        ldr q2, [x1, #-32]                   // ................................................*.......................
        smlsl v28.2D, v23.2S, v0.2S          // ................................................*.......................
        uzp2 v16.4S, v26.4S, v27.4S          // .................................................*......................
        smull2 v27.2D, v3.4S, v19.4S         // .................................................*......................
        smlal2 v25.2D, v17.4S, v5.4S         // ..................................................*.....................
        ldr q5, [x1, #1008]                  // ..................................................*.....................
        ldr q23, [x1, #2000]                 // ...................................................*....................
        smull v30.2D, v18.2S, v30.2S         // ...................................................*....................
        uzp2 v17.4S, v28.4S, v29.4S          // ....................................................*...................
        smull2 v29.2D, v2.4S, v20.4S         // ....................................................*...................
        ldr q21, [x2, #992]                  // .....................................................*..................
        smull v28.2D, v2.2S, v20.2S          // .....................................................*..................
        ldr q2, [x2, #976]                   // ......................................................*.................
        smlal v30.2D, v5.2S, v22.2S          // ......................................................*.................
        ldr q18, [x1, #3024]                 // .......................................................*................
        smlal v30.2D, v7.2S, v6.2S           // .......................................................*................
        smull v26.2D, v3.2S, v19.2S          // ........................................................*...............
        ldr q20, [x1, #992]                  // ........................................................*...............
        smlal2 v31.2D, v5.4S, v22.4S         // .........................................................*..............
        ldr q22, [x2, #2000]                 // .........................................................*..............
        ldr q3, [x2, #2016]                  // ..........................................................*.............
        smlal2 v27.2D, v4.4S, v2.4S          // ..........................................................*.............
        str q17, [x0, #-32]                  // ...........................................................*............
        smlal2 v31.2D, v7.4S, v6.4S          // ...........................................................*............
        smlal2 v29.2D, v20.4S, v21.4S        // ............................................................*...........
        ldr q17, [x2, #3024]                 // ............................................................*...........
        smlal v28.2D, v20.2S, v21.2S         // .............................................................*..........
        ldr q20, [x1, #2016]                 // .............................................................*..........
        smlal v26.2D, v4.2S, v2.2S           // ..............................................................*.........
        ldr q2, [x2, #3040]                  // ..............................................................*.........
        smlal2 v27.2D, v23.4S, v22.4S        // ...............................................................*........
        ldr q21, [x1, #3056]                 // ...............................................................*........
        smlal v26.2D, v23.2S, v22.2S         // ................................................................*.......
        ldr q5, [x1, #3040]                  // ................................................................*.......
        smlal v26.2D, v18.2S, v17.2S         // .................................................................*......
        ldr q22, [x2, #3056]                 // .................................................................*......
        ldr q7, [x2, #4032]                  // ..................................................................*.....
        smlal v28.2D, v20.2S, v3.2S          // ..................................................................*.....
        smlal2 v27.2D, v18.4S, v17.4S        // ...................................................................*....
        str q16, [x0, #-48]                  // ...................................................................*....
        ldr q6, [x1, #4048]                  // ....................................................................*...
        smlal v28.2D, v5.2S, v2.2S           // ....................................................................*...
        smlal v30.2D, v21.2S, v22.2S         // .....................................................................*..
        ldr q19, [x1, #4032]                 // .....................................................................*..
        smlal2 v29.2D, v20.4S, v3.4S         // ......................................................................*.
        ldr q23, [x2, #4080]                 // ......................................................................*.
        smlal2 v29.2D, v5.4S, v2.4S          // .......................................................................*
        ldr q20, [x1, #4080]                 // .......................................................................*

                                              // -------------------------- cycle (expected) --------------------------->
                                              // 0                        25                       50
                                              // |------------------------|------------------------|---------------------
        // smlal2 v31.2D, v21.4S, v22.4S      // .*......................................................................
        // ldr q21, [x2, #4048]               // *.......................................................................
        // smlal2 v31.2D, v20.4S, v23.4S      // ..*.....................................................................
        // ldr q3, [x2, #4064]                // ........*...............................................................
        // smlal v30.2D, v20.2S, v23.2S       // *.......................................................................
        // ldr q22, [x1, #4064]               // ..........*.............................................................
        // smlal2 v25.2D, v19.4S, v7.4S       // ......*.................................................................
        // smlal v24.2D, v19.2S, v7.2S        // ...*....................................................................
        // ldr q7, [x2, #5072]                // ...*....................................................................
        // smlal v26.2D, v6.2S, v21.2S        // ....*...................................................................
        // ldr q18, [x1, #5072]               // .........*..............................................................
        // ldr q23, [x1, #5056]               // .....*..................................................................
        // smlal2 v27.2D, v6.4S, v21.4S       // .....*..................................................................
        // smlal v28.2D, v22.2S, v3.2S        // ...............*........................................................
        // ldr q19, [x2, #5056]               // ....*...................................................................
        // smlal2 v29.2D, v22.4S, v3.4S       // ..............*.........................................................
        // ldr q17, [x1, #5088]               // ..................*.....................................................
        // ldr q3, [x2, #5088]                // ..............*.........................................................
        // smlal2 v27.2D, v18.4S, v7.4S       // .................*......................................................
        // smlal v26.2D, v18.2S, v7.2S        // .............*..........................................................
        // ldr q7, [x2, #5104]                // .*......................................................................
        // smlal2 v25.2D, v23.4S, v19.4S      // ..........*.............................................................
        // ldr q21, [x1, #5104]               // ..*.....................................................................
        // smlal v24.2D, v23.2S, v19.2S       // .........*..............................................................
        // ldr q19, [x1, #6080]               // ......*.................................................................
        // ldr q20, [x2, #6080]               // .......*................................................................
        // smlal v28.2D, v17.2S, v3.2S        // .........................*..............................................
        // ldr q23, [x1, #6096]               // .................*......................................................
        // smlal2 v29.2D, v17.4S, v3.4S       // ......................*.................................................
        // ldr q6, [x2, #6096]                // .............*..........................................................
        // smlal2 v31.2D, v21.4S, v7.4S       // ........*...............................................................
        // smlal v30.2D, v21.2S, v7.2S        // .......*................................................................
        // ldr q21, [x1, #6112]               // ...................*....................................................
        // smlal v24.2D, v19.2S, v20.2S       // ...........*............................................................
        // ldr q3, [x2, #6112]                // ...............*........................................................
        // smlal2 v25.2D, v19.4S, v20.4S      // ............*...........................................................
        // ldr q7, [x1, #6128]                // ...........*............................................................
        // smlal v26.2D, v23.2S, v6.2S        // .....................*..................................................
        // ldr q20, [x2, #6128]               // ............*...........................................................
        // smlal2 v27.2D, v23.4S, v6.4S       // ..........................*.............................................
        // smlal2 v29.2D, v21.4S, v3.4S       // ............................*...........................................
        // smlal v28.2D, v21.2S, v3.2S        // ...........................*............................................
        // uzp1 v21.4S, v24.4S, v25.4S        // ................*.......................................................
        // smlal2 v31.2D, v7.4S, v20.4S       // ....................*...................................................
        // uzp1 v22.4S, v26.4S, v27.4S        // .....................................*..................................
        // mul v6.4S, v21.4S, v1.4S           // ..................*.....................................................
        // mul v3.4S, v22.4S, v1.4S           // .......................................*................................
        // smlal v30.2D, v7.2S, v20.2S        // ................*.......................................................
        // smlsl v24.2D, v6.2S, v0.2S         // .......................*................................................
        // smlsl2 v25.2D, v6.4S, v0.4S        // ........................*...............................................
        // uzp1 v7.4S, v28.4S, v29.4S         // ....................................*...................................
        // smlsl v26.2D, v3.2S, v0.2S         // .............................................*..........................
        // uzp1 v21.4S, v30.4S, v31.4S        // ..............................*.........................................
        // mul v23.4S, v7.4S, v1.4S           // .........................................*..............................
        // mul v16.4S, v21.4S, v1.4S          // ................................*.......................................
        // smlsl2 v27.2D, v3.4S, v0.4S        // ............................................*...........................
        // smlsl v28.2D, v23.2S, v0.2S        // ................................................*.......................
        // smlsl2 v29.2D, v23.4S, v0.4S       // ..............................................*.........................
        // smlsl2 v31.2D, v16.4S, v0.4S       // .....................................*..................................
        // smlsl v30.2D, v16.2S, v0.2S        // ......................................*.................................
        // uzp2 v21.4S, v24.4S, v25.4S        // ............................*...........................................
        // uzp2 v6.4S, v28.4S, v29.4S         // ....................................................*...................
        // uzp2 v24.4S, v30.4S, v31.4S        // ..........................................*.............................
        // uzp2 v30.4S, v26.4S, v27.4S        // .................................................*......................
        // str q6, [x0, #32]                  // ...........................................................*............
        // str q21, [x0], #4*16               // ...........................................*............................
        // str q24, [x0, #-16]                // ...............................................*........................
        // str q30, [x0, #-48]                // ...................................................................*....
        // ldr q17, [x1], #4*16               // ......................*.................................................
        // ldr q4, [x2], #4*16                // ...................*....................................................
        // ldr q5, [x1, #-48]                 // .........................................*..............................
        // ldr q31, [x2, #-48]                // .............................................*..........................
        // ldr q26, [x2, #-32]                // ......................................*.................................
        // ldr q20, [x1, #-16]                // .......................................*................................
        // ldr q16, [x1, #-32]                // ................................................*.......................
        // smull v24.2D, v17.2S, v4.2S        // .............................*..........................................
        // ldr q18, [x2, #-16]                // ..........................................*.............................
        // smull2 v27.2D, v5.4S, v31.4S       // .................................................*......................
        // ldr q7, [x1, #976]                 // ..............................................*.........................
        // smull2 v25.2D, v17.4S, v4.4S       // ..............................*.........................................
        // ldr q23, [x1, #960]                // .....................*..................................................
        // smull v28.2D, v16.2S, v26.2S       // .....................................................*..................
        // ldr q21, [x2, #976]                // ......................................................*.................
        // smull2 v29.2D, v16.4S, v26.4S      // ....................................................*...................
        // ldr q19, [x1, #2016]               // .............................................................*..........
        // ldr q22, [x2, #960]                // ........................*...............................................
        // smull v30.2D, v20.2S, v18.2S       // ...................................................*....................
        // smull v26.2D, v5.2S, v31.2S        // ........................................................*...............
        // ldr q4, [x1, #1008]                // ..................................................*.....................
        // smlal v26.2D, v7.2S, v21.2S        // ..............................................................*.........
        // ldr q16, [x2, #992]                // .....................................................*..................
        // smull2 v31.2D, v20.4S, v18.4S      // ...............................................*........................
        // ldr q5, [x1, #992]                 // ........................................................*...............
        // smlal2 v25.2D, v23.4S, v22.4S      // ...............................*........................................
        // smlal v24.2D, v23.2S, v22.2S       // ..................................*.....................................
        // ldr q18, [x2, #1008]               // ........................................*...............................
        // smlal2 v27.2D, v7.4S, v21.4S       // ..........................................................*.............
        // ldr q22, [x1, #1984]               // .......................*................................................
        // smlal v28.2D, v5.2S, v16.2S        // .............................................................*..........
        // ldr q17, [x2, #1984]               // .............................*..........................................
        // smlal2 v29.2D, v5.4S, v16.4S       // ............................................................*...........
        // ldr q16, [x2, #2000]               // .........................................................*..............
        // smlal v30.2D, v4.2S, v18.2S        // ......................................................*.................
        // ldr q5, [x1, #2000]                // ...................................................*....................
        // smlal2 v31.2D, v4.4S, v18.4S       // .........................................................*..............
        // ldr q4, [x2, #2016]                // ..........................................................*.............
        // smlal v24.2D, v22.2S, v17.2S       // ...................................*....................................
        // ldr q2, [x1, #2032]                // ............................................*...........................
        // smlal2 v25.2D, v22.4S, v17.4S      // ...........................................*............................
        // ldr q22, [x1, #3024]               // .......................................................*................
        // ldr q18, [x2, #2032]               // ........................................*...............................
        // smlal v26.2D, v5.2S, v16.2S        // ................................................................*.......
        // smlal2 v27.2D, v5.4S, v16.4S       // ...............................................................*........
        // smlal2 v31.2D, v2.4S, v18.4S       // ...........................................................*............
        // ldr q5, [x2, #3024]                // ............................................................*...........
        // smlal2 v29.2D, v19.4S, v4.4S       // ......................................................................*.
        // ldr q3, [x1, #3008]                // ..........................*.............................................
        // ldr q23, [x2, #3008]               // ...........................*............................................
        // smlal v30.2D, v2.2S, v18.2S        // .......................................................*................
        // smlal v28.2D, v19.2S, v4.2S        // ..................................................................*.....
        // ldr q16, [x2, #3040]               // ..............................................................*.........
        // ldr q17, [x1, #3040]               // ................................................................*.......
        // smlal v26.2D, v22.2S, v5.2S        // .................................................................*......
        // smlal2 v27.2D, v22.4S, v5.4S       // ...................................................................*....
        // ldr q22, [x2, #3056]               // .................................................................*......
        // ldr q21, [x1, #3056]               // ...............................................................*........
        // smlal2 v25.2D, v3.4S, v23.4S       // ..................................................*.....................
        // smlal v24.2D, v3.2S, v23.2S        // ....................................*...................................
        // ldr q20, [x1, #4080]               // .......................................................................*
        // ldr q23, [x2, #4080]               // ......................................................................*.
        // smlal2 v29.2D, v17.4S, v16.4S      // .......................................................................*
        // smlal v28.2D, v17.2S, v16.2S       // ....................................................................*...
        // ldr q7, [x2, #4032]                // ..................................................................*.....
        // smlal v30.2D, v21.2S, v22.2S       // .....................................................................*..
        // ldr q19, [x1, #4032]               // .....................................................................*..
        // ldr q6, [x1, #4048]                // ....................................................................*...

        subs count, count, 4
        cbnz count, l7_loop_start
        smlal2 v31.2D, v21.4S, v22.4S        // .....................................*..............................................
        ldr q21, [x2, #4048]                 // ......................................*.............................................
        smlal2 v31.2D, v20.4S, v23.4S        // ......................................*.............................................
        ldr q3, [x2, #4064]                  // .......................................*............................................
        smlal v30.2D, v20.2S, v23.2S         // .......................................*............................................
        ldr q22, [x1, #4064]                 // ........................................*...........................................
        smlal2 v25.2D, v19.4S, v7.4S         // ........................................*...........................................
        smlal v24.2D, v19.2S, v7.2S          // .........................................*..........................................
        ldr q7, [x2, #5072]                  // .........................................*..........................................
        smlal v26.2D, v6.2S, v21.2S          // ..........................................*.........................................
        ldr q18, [x1, #5072]                 // ..........................................*.........................................
        ldr q23, [x1, #5056]                 // ...........................................*........................................
        smlal2 v27.2D, v6.4S, v21.4S         // ...........................................*........................................
        smlal v28.2D, v22.2S, v3.2S          // ............................................*.......................................
        ldr q19, [x2, #5056]                 // ............................................*.......................................
        smlal2 v29.2D, v22.4S, v3.4S         // .............................................*......................................
        ldr q17, [x1, #5088]                 // .............................................*......................................
        ldr q3, [x2, #5088]                  // ..............................................*.....................................
        smlal2 v27.2D, v18.4S, v7.4S         // ..............................................*.....................................
        smlal v26.2D, v18.2S, v7.2S          // ...............................................*....................................
        ldr q7, [x2, #5104]                  // ...............................................*....................................
        smlal2 v25.2D, v23.4S, v19.4S        // ................................................*...................................
        ldr q21, [x1, #5104]                 // ................................................*...................................
        smlal v24.2D, v23.2S, v19.2S         // .................................................*..................................
        ldr q19, [x1, #6080]                 // .................................................*..................................
        ldr q20, [x2, #6080]                 // ..................................................*.................................
        smlal v28.2D, v17.2S, v3.2S          // ..................................................*.................................
        ldr q23, [x1, #6096]                 // ...................................................*................................
        smlal2 v29.2D, v17.4S, v3.4S         // ...................................................*................................
        ldr q6, [x2, #6096]                  // ....................................................*...............................
        smlal2 v31.2D, v21.4S, v7.4S         // ....................................................*...............................
        smlal v30.2D, v21.2S, v7.2S          // .....................................................*..............................
        ldr q21, [x1, #6112]                 // .....................................................*..............................
        smlal v24.2D, v19.2S, v20.2S         // ......................................................*.............................
        ldr q3, [x2, #6112]                  // ......................................................*.............................
        smlal2 v25.2D, v19.4S, v20.4S        // .......................................................*............................
        ldr q7, [x1, #6128]                  // .......................................................*............................
        smlal v26.2D, v23.2S, v6.2S          // ........................................................*...........................
        ldr q20, [x2, #6128]                 // ........................................................*...........................
        smlal2 v27.2D, v23.4S, v6.4S         // .........................................................*..........................
        smlal2 v29.2D, v21.4S, v3.4S         // ..........................................................*.........................
        smlal v28.2D, v21.2S, v3.2S          // ...........................................................*........................
        uzp1 v21.4S, v24.4S, v25.4S          // ...........................................................*........................
        smlal2 v31.2D, v7.4S, v20.4S         // ............................................................*.......................
        uzp1 v22.4S, v26.4S, v27.4S          // .............................................................*......................
        mul v6.4S, v21.4S, v1.4S             // .............................................................*......................
        mul v3.4S, v22.4S, v1.4S             // ...............................................................*....................
        smlal v30.2D, v7.2S, v20.2S          // .................................................................*..................
        smlsl v24.2D, v6.2S, v0.2S           // ..................................................................*.................
        smlsl2 v25.2D, v6.4S, v0.4S          // ...................................................................*................
        uzp1 v7.4S, v28.4S, v29.4S           // ...................................................................*................
        smlsl v26.2D, v3.2S, v0.2S           // ....................................................................*...............
        uzp1 v21.4S, v30.4S, v31.4S          // .....................................................................*..............
        mul v23.4S, v7.4S, v1.4S             // .....................................................................*..............
        mul v16.4S, v21.4S, v1.4S            // .......................................................................*............
        smlsl2 v27.2D, v3.4S, v0.4S          // .........................................................................*..........
        smlsl v28.2D, v23.2S, v0.2S          // ..........................................................................*.........
        smlsl2 v29.2D, v23.4S, v0.4S         // ...........................................................................*........
        smlsl2 v31.2D, v16.4S, v0.4S         // ............................................................................*.......
        smlsl v30.2D, v16.2S, v0.2S          // .............................................................................*......
        uzp2 v21.4S, v24.4S, v25.4S          // .............................................................................*......
        uzp2 v6.4S, v28.4S, v29.4S           // ...............................................................................*....
        uzp2 v24.4S, v30.4S, v31.4S          // .................................................................................*..
        uzp2 v30.4S, v26.4S, v27.4S          // .................................................................................*..
        str q6, [x0, #32]                    // ..................................................................................*.
        str q21, [x0], #4*16                 // ..................................................................................*.
        str q24, [x0, #-16]                  // ...................................................................................*
        str q30, [x0, #-48]                  // ...................................................................................*

    ret

    .unreq out_ptr
    .unreq a_ptr
    .unreq b_ptr
    .unreq count
    .unreq wtmp
    .unreq modulus
    .unreq modulus_twisted
    .unreq a_0
    .unreq a_1
    .unreq a_2
    .unreq a_3
    .unreq b_0
    .unreq b_1
    .unreq b_2
    .unreq b_3
    .unreq c_0_lo
    .unreq c_0_hi
    .unreq c_1_lo
    .unreq c_1_hi
    .unreq c_2_lo
    .unreq c_2_hi
    .unreq c_3_lo
    .unreq c_3_hi
    .unreq c_0
    .unreq c_1
    .unreq c_2
    .unreq c_3
    .unreq q_a_0
    .unreq q_a_1
    .unreq q_a_2
    .unreq q_a_3
    .unreq q_b_0
    .unreq q_b_1
    .unreq q_b_2
    .unreq q_b_3
    .unreq q_c_0
    .unreq q_c_1
    .unreq q_c_2
    .unreq q_c_3

/* simpasm: footer-start */
#endif /* MLD_ARITH_BACKEND_AARCH64 */
