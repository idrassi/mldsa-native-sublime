/*
 * Copyright (c) The mldsa-native project authors
 * SPDX-License-Identifier: Apache-2.0 OR ISC OR MIT
 */
#include "../../../common.h"

#if defined(MLD_ARITH_BACKEND_AARCH64) && !defined(MLD_CONFIG_MULTILEVEL_NO_SHARED)

.macro caddq inout
        ushr tmp.4s, \inout\().4s, #31
        mla \inout\().4s, tmp.4s, q_reg.4s
.endm

.global MLD_ASM_NAMESPACE(poly_caddq_asm)
.balign 16
MLD_ASM_FN_SYMBOL(poly_caddq_asm)
        // Function signature: void mld_poly_caddq_asm(int32_t *a)
        // x0: pointer to polynomial coefficients

        // Register assignments
        a_ptr           .req x0
        count           .req x1
        q_reg           .req v4
        tmp             .req v5

        // Load constants
        // MLDSA_Q = 8380417 = 0x7FE001
        movz w9, #0xE001
        movk w9, #0x7F, lsl #16
        dup q_reg.4s, w9        // Load Q values

        mov count, #64/4
                                        // Instructions:    13
                                        // Expected cycles: 12
                                        // Expected IPC:    1.08
                                        //
                                        // Cycle bound:     12.0
                                        // IPC bound:       1.08
                                        //
                                        // Wall time:     0.04s
                                        // User time:     0.04s
                                        //
                                        // ----- cycle (expected) ------>
                                        // 0                        25
                                        // |------------------------|----
        ldr q2, [x0, #16]               // *.............................
        ldr q3, [x0, #80]               // *.............................
        ldr q19, [x0, #48]              // .*............................
        ldr q7, [x0, #0]                // .*............................
        ldr q15, [x0, #32]              // ..*...........................
        ushr v1.4S, v2.4S, #31          // ....*.........................
        ushr v27.4S, v3.4S, #31         // .....*........................
        mla v2.4S, v1.4S, v4.4S         // ......*.......................
        ushr v1.4S, v19.4S, #31         // ......*.......................
        ushr v0.4S, v7.4S, #31          // .......*......................
        mla v3.4S, v27.4S, v4.4S        // ........*.....................
        mla v19.4S, v1.4S, v4.4S        // ..........*...................
        str q2, [x0, #16]               // ...........*..................

                                          // ------ cycle (expected) ------>
                                          // 0                        25
                                          // |------------------------|-----
        // ldr q3, [x0, #16]              // *..............................
        // ushr v18.4S, v3.4S, #31        // ....*..........................
        // mla v3.4S, v18.4S, v4.4S       // ......*........................
        // str q3, [x0, #16]              // ...........*...................
        // ldr q3, [x0, #80]              // *..............................
        // ldr q19, [x0, #48]             // .*.............................
        // ushr v18.4S, v3.4S, #31        // .....*.........................
        // ldr q7, [x0, #0]               // .*.............................
        // mla v3.4S, v18.4S, v4.4S       // ........*......................
        // ushr v11.4S, v19.4S, #31       // ......*........................
        // mla v19.4S, v11.4S, v4.4S      // ..........*....................
        // ushr v0.4S, v7.4S, #31         // .......*.......................
        // ldr q15, [x0, #32]             // ..*............................

        sub count, count, #2
poly_caddq_loop:
                                         // Instructions:    16
                                         // Expected cycles: 12
                                         // Expected IPC:    1.33
                                         //
                                         // Cycle bound:     12.0
                                         // IPC bound:       1.33
                                         //
                                         // Wall time:     42.90s
                                         // User time:     42.90s
                                         //
                                         // ----- cycle (expected) ------>
                                         // 0                        25
                                         // |------------------------|----
        str q3, [x0, #80]                // *.............................
        mla v7.4S, v0.4S, v4.4S          // l.............................
        ldr q3, [x0, #144]               // .e............................
        ushr v23.4S, v15.4S, #31         // ..l...........................
        str q19, [x0, #48]               // ..l...........................
        ldr q19, [x0, #112]              // ...*..........................
        mla v15.4S, v23.4S, v4.4S        // ....l.........................
        ushr v18.4S, v3.4S, #31          // .....e........................
        str q7, [x0], #4*16              // .....l........................
        ldr q7, [x0, #0]                 // ......*.......................
        mla v3.4S, v18.4S, v4.4S         // .......e......................
        ushr v11.4S, v19.4S, #31         // .......*......................
        mla v19.4S, v11.4S, v4.4S        // .........*....................
        str q15, [x0, #-32]              // .........l....................
        ushr v0.4S, v7.4S, #31           // ..........*...................
        ldr q15, [x0, #32]               // ..........*...................

                                        // ------- cycle (expected) ------->
                                        // 0                        25
                                        // |------------------------|-------
        // ldr q0, [x0, #0*16]          // .....~.....'.....*.....'.....~...
        // ldr q1, [x0, #1*16]          // e..........'~..........'~........
        // ldr q2, [x0, #2*16]          // .........~.'.........*.'.........
        // ldr q3, [x0, #3*16]          // ..~........'..*........'..~......
        // ushr v5.4s, v0.4s, #31       // .........~.'.........*.'.........
        // mla v0.4s, v5.4s, v4.4s      // ...........~...........l.........
        // ushr v5.4s, v1.4s, #31       // ....e......'....~......'....~....
        // mla v1.4s, v5.4s, v4.4s      // ......e....'......~....'......~..
        // ushr v5.4s, v2.4s, #31       // .~.........'.~.........'.l.......
        // mla v2.4s, v5.4s, v4.4s      // ...~.......'...~.......'...l.....
        // ushr v5.4s, v3.4s, #31       // ......~....'......*....'......~..
        // mla v3.4s, v5.4s, v4.4s      // ........~..'........*..'.........
        // str q1, [x0, #1*16]          // ...........*...........~.........
        // str q2, [x0, #2*16]          // ........~..'........~..'........l
        // str q3, [x0, #3*16]          // .~.........'.~.........'.l.......
        // str q0, [x0], #4*16          // ....~......'....~......'....l....

        subs count, count, #1
        bne poly_caddq_loop
                                         // Instructions:    19
                                         // Expected cycles: 16
                                         // Expected IPC:    1.19
                                         //
                                         // Cycle bound:     16.0
                                         // IPC bound:       1.19
                                         //
                                         // Wall time:     0.08s
                                         // User time:     0.08s
                                         //
                                         // ----- cycle (expected) ------>
                                         // 0                        25
                                         // |------------------------|----
        str q3, [x0, #80]                // *.............................
        ldr q2, [x0, #112]               // *.............................
        mla v7.4S, v0.4S, v4.4S          // .*............................
        str q19, [x0, #48]               // .*............................
        ushr v19.4S, v15.4S, #31         // ..*...........................
        ldr q1, [x0, #64]                // ..*...........................
        ldr q27, [x0, #96]               // ...*..........................
        mla v15.4S, v19.4S, v4.4S        // ....*.........................
        ushr v19.4S, v2.4S, #31          // ....*.........................
        mla v2.4S, v19.4S, v4.4S         // ......*.......................
        ushr v19.4S, v1.4S, #31          // ......*.......................
        str q7, [x0], #4*16              // .......*......................
        ushr v29.4S, v27.4S, #31         // .......*......................
        mla v1.4S, v19.4S, v4.4S         // ........*.....................
        str q15, [x0, #-32]              // .........*....................
        mla v27.4S, v29.4S, v4.4S        // ..........*...................
        str q2, [x0, #48]                // ...........*..................
        str q1, [x0], #4*16              // .............*................
        str q27, [x0, #-32]              // ...............*..............

                                          // ------ cycle (expected) ------>
                                          // 0                        25
                                          // |------------------------|-----
        // str q3, [x0, #80]              // *..............................
        // mla v7.4S, v0.4S, v4.4S        // .*.............................
        // ushr v23.4S, v15.4S, #31       // ..*............................
        // str q19, [x0, #48]             // .*.............................
        // ldr q19, [x0, #112]            // *..............................
        // mla v15.4S, v23.4S, v4.4S      // ....*..........................
        // str q7, [x0], #4*16            // .......*.......................
        // ldr q7, [x0, #0]               // ..*............................
        // ushr v11.4S, v19.4S, #31       // ....*..........................
        // mla v19.4S, v11.4S, v4.4S      // ......*........................
        // str q15, [x0, #-32]            // .........*.....................
        // ushr v0.4S, v7.4S, #31         // ......*........................
        // ldr q15, [x0, #32]             // ...*...........................
        // mla v7.4S, v0.4S, v4.4S        // ........*......................
        // ushr v23.4S, v15.4S, #31       // .......*.......................
        // str q19, [x0, #48]             // ...........*...................
        // mla v15.4S, v23.4S, v4.4S      // ..........*....................
        // str q7, [x0], #4*16            // .............*.................
        // str q15, [x0, #-32]            // ...............*...............


        ret

        .unreq a_ptr
        .unreq count
        .unreq q_reg
        .unreq tmp

#endif /* MLD_ARITH_BACKEND_AARCH64 && !MLD_CONFIG_MULTILEVEL_NO_SHARED */
