/*
 * Copyright (c) The mldsa-native project authors
 * SPDX-License-Identifier: Apache-2.0 OR ISC OR MIT
 */
#include "../../../common.h"

#if defined(MLD_ARITH_BACKEND_AARCH64) && !defined(MLD_CONFIG_MULTILEVEL_NO_SHARED)

.macro caddq inout
        ushr tmp.4s, \inout\().4s, #31
        mla \inout\().4s, tmp.4s, q_reg.4s
.endm

.global MLD_ASM_NAMESPACE(poly_caddq_asm)
.balign 16
MLD_ASM_FN_SYMBOL(poly_caddq_asm)
        // Function signature: void mld_poly_caddq_asm(int32_t *a)
        // x0: pointer to polynomial coefficients

        // Register assignments
        a_ptr           .req x0
        count           .req x1
        q_reg           .req v4
        tmp             .req v5

        // Load constants
        // MLDSA_Q = 8380417 = 0x7FE001
        movz w9, #0xE001
        movk w9, #0x7F, lsl #16
        dup q_reg.4s, w9        // Load Q values

        mov count, #64/4
                                        // Instructions:    6
                                        // Expected cycles: 9
                                        // Expected IPC:    0.67
                                        //
                                        // Cycle bound:     9.0
                                        // IPC bound:       0.67
                                        //
                                        // Wall time:     0.01s
                                        // User time:     0.01s
                                        //
                                        // ----- cycle (expected) ------>
                                        // 0                        25
                                        // |------------------------|----
        ldr q5, [x0, #16]               // *.............................
        ldr q6, [x0, #0]                // ..*...........................
        ushr v30.4S, v5.4S, #31         // ....*.........................
        mla v5.4S, v30.4S, v4.4S        // ......*.......................
        ushr v18.4S, v6.4S, #31         // .......*......................
        ldr q10, [x0, #48]              // ........*.....................

                                        // ------ cycle (expected) ------>
                                        // 0                        25
                                        // |------------------------|-----
        // ldr q5, [x0, #16]            // *..............................
        // ldr q6, [x0, #0]             // ..*............................
        // ushr v2.4S, v5.4S, #31       // ....*..........................
        // mla v5.4S, v2.4S, v4.4S      // ......*........................
        // ldr q10, [x0, #48]           // ........*......................
        // ushr v18.4S, v6.4S, #31      // .......*.......................

        sub count, count, #1
poly_caddq_loop:
                                        // Instructions:    16
                                        // Expected cycles: 20
                                        // Expected IPC:    0.80
                                        //
                                        // Cycle bound:     20.0
                                        // IPC bound:       0.80
                                        //
                                        // Wall time:     0.99s
                                        // User time:     0.99s
                                        //
                                        // ----- cycle (expected) ------>
                                        // 0                        25
                                        // |------------------------|----
        str q5, [x0, #16]               // *.............................
        ldr q30, [x0, #32]              // .*............................
        mla v6.4S, v18.4S, v4.4S        // ...*..........................
        ushr v7.4S, v10.4S, #31         // ....*.........................
        ushr v2.4S, v30.4S, #31         // .....*........................
        mla v10.4S, v7.4S, v4.4S        // ......*.......................
        mla v30.4S, v2.4S, v4.4S        // .......*......................
        str q6, [x0], #4*16             // ........*.....................
        ldr q5, [x0, #16]               // .........e....................
        str q30, [x0, #-32]             // ...........*..................
        ldr q6, [x0, #0]                // ............e.................
        ushr v2.4S, v5.4S, #31          // ..............e...............
        str q10, [x0, #-16]             // ...............*..............
        mla v5.4S, v2.4S, v4.4S         // ................e.............
        ldr q10, [x0, #48]              // .................e............
        ushr v18.4S, v6.4S, #31         // ...................e..........

                                        // ------ cycle (expected) ------>
                                        // 0                        25
                                        // |------------------------|-----
        // ldr q0, [x0, #0*16]          // ...e.......'...........~.......
        // ldr q1, [x0, #1*16]          // e..........'........~..........
        // ldr q2, [x0, #2*16]          // ...........'*..................
        // ldr q3, [x0, #3*16]          // ........e..'................~..
        // ushr v5.4s, v0.4s, #31       // ..........e'...................
        // mla v0.4s, v5.4s, v4.4s      // ...........'..*................
        // ushr v5.4s, v1.4s, #31       // .....e.....'.............~.....
        // mla v1.4s, v5.4s, v4.4s      // .......e...'...............~...
        // ushr v5.4s, v2.4s, #31       // ...........'....*..............
        // mla v2.4s, v5.4s, v4.4s      // ...........'......*............
        // ushr v5.4s, v3.4s, #31       // ...........'...*...............
        // mla v3.4s, v5.4s, v4.4s      // ...........'.....*.............
        // str q1, [x0, #1*16]          // ...........*...................
        // str q2, [x0, #2*16]          // ..~........'..........*........
        // str q3, [x0, #3*16]          // ......~....'..............*....
        // str q0, [x0], #4*16          // ...........'.......*...........

        subs count, count, #1
        bne poly_caddq_loop
                                         // Instructions:    10
                                         // Expected cycles: 13
                                         // Expected IPC:    0.77
                                         //
                                         // Cycle bound:     13.0
                                         // IPC bound:       0.77
                                         //
                                         // Wall time:     0.02s
                                         // User time:     0.02s
                                         //
                                         // ----- cycle (expected) ------>
                                         // 0                        25
                                         // |------------------------|----
        str q5, [x0, #16]                // *.............................
        ldr q30, [x0, #32]               // .*............................
        mla v6.4S, v18.4S, v4.4S         // ...*..........................
        ushr v23.4S, v10.4S, #31         // ....*.........................
        ushr v21.4S, v30.4S, #31         // .....*........................
        mla v10.4S, v23.4S, v4.4S        // ......*.......................
        mla v30.4S, v21.4S, v4.4S        // .......*......................
        str q6, [x0], #4*16              // ........*.....................
        str q10, [x0, #-16]              // ..........*...................
        str q30, [x0, #-32]              // ............*.................

                                         // ------ cycle (expected) ------>
                                         // 0                        25
                                         // |------------------------|-----
        // str q5, [x0, #16]             // *..............................
        // ldr q30, [x0, #32]            // .*.............................
        // mla v6.4S, v18.4S, v4.4S      // ...*...........................
        // ushr v7.4S, v10.4S, #31       // ....*..........................
        // ushr v2.4S, v30.4S, #31       // .....*.........................
        // mla v10.4S, v7.4S, v4.4S      // ......*........................
        // mla v30.4S, v2.4S, v4.4S      // .......*.......................
        // str q6, [x0], #4*16           // ........*......................
        // str q30, [x0, #-32]           // ............*..................
        // str q10, [x0, #-16]           // ..........*....................


        ret

        .unreq a_ptr
        .unreq count
        .unreq q_reg
        .unreq tmp

#endif /* MLD_ARITH_BACKEND_AARCH64 && !MLD_CONFIG_MULTILEVEL_NO_SHARED */
